<!DOCTYPE HTML>
<html lang="zh-Hans">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="MySQL高级, HX-Blog">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>MySQL高级 | HX-Blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 6.3.0"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">HX-Blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>About</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>Contact</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>Friends</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">HX-Blog</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			About
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			Contact
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			Friends
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/23.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">MySQL高级</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">
                                <span class="chip bg-color">数据库</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-07-10
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="MySQL高级"><a href="#MySQL高级" class="headerlink" title="MySQL高级"></a>MySQL高级</h1><h2 id="1-MySQL架构介绍"><a href="#1-MySQL架构介绍" class="headerlink" title="1. MySQL架构介绍"></a>1. MySQL架构介绍</h2><h3 id="1-1-MySQL简介"><a href="#1-1-MySQL简介" class="headerlink" title="1.1 MySQL简介"></a>1.1 MySQL简介</h3><h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><p>MySQL是一个关系型数据库管理系统，由瑞典MySQL AB公司开发，目前属于Oracle公司。</p>
<p>MySQL是一种关联数据库管理系统，将数据保存在不同的表中，而不是将所有数据放在一个大仓库内，这样就增加了速度并提高了灵活性。</p>
<p>MySQL是开源的，所以你不需要支付额外的费用。</p>
<p>MySQL支持大型的数据库。可以处理拥有上千万条记录的大型数据库。MySQL使用标准的SQL数据语言形式。</p>
<p>MySQL可以允许于多个系统上，并且支持多种语言。这些编程语言包括C、C++、Python、Java、Per、PHP、Eifel、Ruby和Tcl等。Mysql对PHP有很好的支持，PHP是目前最流行的Web开发语言。</p>
<p>MySQL支持大型数据库，支持5000万条记录的数据仓库，32位系统表文件最大可支持4GB，64位系统支持最大的表文件为8TB。Mysql是可以定制的，采用了GPL协议，你可以修改源码来开发自己的MySQL系统。</p>
<h4 id="高级MySQL"><a href="#高级MySQL" class="headerlink" title="高级MySQL"></a><strong>高级MySQL</strong></h4><p>MySQL内核</p>
<p><a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=SQL%E4%BC%98%E5%8C%96&spm=1001.2101.3001.7020">SQL优化</a>攻城狮</p>
<p>MySQL服务器的优化</p>
<p>各种参数常量设定</p>
<p>查询语句优化</p>
<p>主从复制</p>
<p>软硬件升级</p>
<p>容灾备份</p>
<p>SQL编程</p>
<p>完整的MySQL优化需要很深的功底，大公司甚至有专门的DBA写上述。</p>
<h3 id="1-2-MySQLLinux版安装"><a href="#1-2-MySQLLinux版安装" class="headerlink" title="1.2 MySQLLinux版安装"></a>1.2 MySQLLinux版安装</h3><p>启动MySQL：service mysql start</p>
<p>mysql -u root -p</p>
<p>输入密码123456</p>
<p>show databases;查看数据库</p>
<p>create database 数据库名   创建数据库</p>
<p>use 数据库名 使用当前的数据库</p>
<p>show tables 查看当前数据库中的表</p>
<p>create table 表名 （字段 类型）；创建表</p>
<p>insert into 表名 values(数据)：插入数据</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1652953132370.png"></p>
<p>出现了中文乱码，要修改vim &#x2F;etc&#x2F;my.cnf</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1652953632623.png"></p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1652953652278.png"></p>
<p> <strong>重新连接后重新create databse并使用新建库，然后再重新建表试试</strong> ,没有修改之前所建成的数据库写汉字还是乱码，但改过后新建的数据库插入汉字后不乱码了。</p>
<h3 id="1-3-MySQL配置文件"><a href="#1-3-MySQL配置文件" class="headerlink" title="1.3 MySQL配置文件"></a>1.3 MySQL配置文件</h3><ul>
<li><p>二进制日志log-bin用于主从复制</p>
</li>
<li><p>错误日志log-error</p>
</li>
<li><p>查询日志log</p>
</li>
<li><p>数据文件</p>
<ul>
<li>​	两系统： linux 是默认存放在&#x2F;var&#x2F;lib&#x2F;mysql下，window是</li>
<li>frm文件：是存放表结构的</li>
<li>myd文件：是存放表数据</li>
<li>myi文件：是存放表索引的</li>
</ul>
</li>
<li><p>如何配置</p>
<ul>
<li>window下的配置文件是my.ini文件</li>
<li>linus下的配置文件时&#x2F;etc&#x2F;my.cnf文件</li>
</ul>
</li>
</ul>
<h3 id="1-4-MySQL逻辑架构介绍"><a href="#1-4-MySQL逻辑架构介绍" class="headerlink" title="1.4 MySQL逻辑架构介绍"></a>1.4 MySQL逻辑架构介绍</h3><p><strong>总体概览</strong></p>
<p>和其它数据库相比，MySQL有点与众不同，它的架构可以在多种不同场景中应用并发挥良好作用。主要体现在存储引擎的架构上，</p>
<p><strong>插件式的存储引擎架构将查询处理和其它的系统任务以及数据的存储提取相分离。这种架构可以根据业务的需求和实际需要选择合适的存储引擎。</strong></p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653033180782.png"></p>
<p>1.连接层——Connectors</p>
<p>最上层是一些客户端和连接服务，包含本地sock通信和大多数基于客户端&#x2F;服务端工具实现的类似于tcplip的通信。主要完成一些类似于连接处理、授权认证、及相关的安全方案。在该层上引入了线程池的概念，为通过认证安全接入的客户端提供线程。同样在该层上可以实现基于SSL的安全链接。服务器也会为安全接入的每个客户端验证它所具有的操作权限。</p>
<p>2.服务层  </p>
<p>第二层架构主要完成大多少的核心服务功能，如SQL接口，并完成缓存的查询，SQL的分析和优化及部分内置函数的执行。所有跨存储引擎的功能也在这一层实现，如过程、函数等。在该层，服务器会解析查询并创建相应的内部解析树，并对其完成相应的优化如确定查询表的顺序是否利用索引等，最后生成相应的执行操作。如果是select语句，服务器还会查询内部的缓存。如果缓存空间足够大，这样在解决大量读操作的环境中能够很好的提升系统的性能。</p>
<p>Connection Pool:连接池</p>
<p>Management Services &amp; Utilities:</p>
<p>SQL Interface:sql接口，看是写操作还是读操作还是其他</p>
<p>optimizer：mysql优化器 MySQL的执行语句按照优化器自己认为的最优进行执行，可能不是程序员认为最优的</p>
<p>caches&amp;Buffers:缓存和缓冲</p>
<p>3.引擎层</p>
<p>Pluggable Storage Engines:可拔插的存储引擎，mysql支持多种数据库的存储引擎，目前主流、主要项目中用的是MyISAM和InnoDB,</p>
<p>存储引擎层，存储引擎真正的负责了MySQL中数据的存储和提取，服务器通过API与存储引擎进行通信。不同的存储引擎具有的功能不同这样我们可以根据自己的实际需要进行选取，后面介绍MyISAM和InnoDB。</p>
<p>4.存储层</p>
<p>文件存储层</p>
<p>数据存储层，主要是将数据存储在运行于裸设备的文件系统之上，并完成与存储引擎的交互。</p>
<p>MySQL是分层的，是插件式的可拔插的结构</p>
<h3 id="1-5-MySQL存储引擎"><a href="#1-5-MySQL存储引擎" class="headerlink" title="1.5 MySQL存储引擎"></a>1.5 MySQL存储引擎</h3><p>查看命令：</p>
<ul>
<li>查看mysql以提供什么存储引擎<ul>
<li><code>show engines;</code></li>
</ul>
</li>
</ul>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653036019113.png"></p>
<ul>
<li>查看mysql当前默认的存储引擎<ul>
<li><code>show variables like &#39;%storage_engine%&#39;;</code></li>
</ul>
</li>
</ul>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653036126342.png"></p>
<p>MyISAM和InnoDB</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653036418960.png"></p>
<p> <strong>阿里巴巴、淘宝用哪个？</strong> </p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653036440227.png"></p>
<ul>
<li><p>Percona为MySQL数据库服务器进行了改进，在功能和性能上较MySQL有着很显著的提升。该版本提升了在高负载情况下的InnoDB的性能、为DBA提供一些非常有用的性能诊断工具；另外有更多的参数和命令来控制服务器行为。</p>
</li>
<li><p>该公司新建了一款存储引擎叫xtradb完全可以替代innodb,并且在性能和并发上做得更好，</p>
</li>
<li><p>阿里巴巴大部分mysql数据库其实使用的percona的原型加以修改。</p>
</li>
</ul>
<p>AliSql+AliRedis</p>
<h2 id="2-索引优化"><a href="#2-索引优化" class="headerlink" title="2.索引优化"></a>2.索引优化</h2><h3 id="2-1-SQL性能下降原因"><a href="#2-1-SQL性能下降原因" class="headerlink" title="2.1 SQL性能下降原因"></a>2.1 SQL性能下降原因</h3><p>执行时间长，等待时间长</p>
<ul>
<li><p>查询语句写的烂</p>
</li>
<li><p>索引失效（索引存在但没有使用）</p>
<ul>
<li><p>单值<br>select * from user where name&#x3D;’’;&#x2F;&#x2F;查询语句<br>create index idx_user_name on user(name);&#x2F;&#x2F;创建索引</p>
<p>create index idx_表名__索引名 on 表名（给哪个字段建索引）</p>
</li>
<li><p>复合<br>select * from user where name&#x3D;’’ and email&#x3D;’’;<br>create index idx_user_nameEmail on user(name, email);</p>
</li>
</ul>
</li>
<li><p>关联查询太多join（设计缺陷或不得已的需求）</p>
</li>
<li><p>服务器调优及各个参数设置（缓冲、线程数等）</p>
</li>
</ul>
<h3 id="2-2-常用的join查询"><a href="#2-2-常用的join查询" class="headerlink" title="2.2 常用的join查询"></a>2.2 常用的join查询</h3><h4 id="2-2-1-SQL执行加载顺序"><a href="#2-2-1-SQL执行加载顺序" class="headerlink" title="2.2.1 SQL执行加载顺序"></a>2.2.1 SQL执行加载顺序</h4><ul>
<li><p>手写</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span></span><br><span class="line">    <span class="operator">&lt;</span>select_list<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="operator">&lt;</span>left_table<span class="operator">&gt;</span> <span class="operator">&lt;</span>join_type<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">JOIN</span> </span><br><span class="line">    <span class="operator">&lt;</span>right_table<span class="operator">&gt;</span> </span><br><span class="line"><span class="keyword">ON</span></span><br><span class="line">    <span class="operator">&lt;</span>join_condition<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    <span class="operator">&lt;</span>where_condition<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="operator">&lt;</span>group_by_list<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">HAVING</span></span><br><span class="line">    <span class="operator">&lt;</span>having_condition<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="operator">&lt;</span>order_by_condition<span class="operator">&gt;</span></span><br><span class="line">LIMIT</span><br><span class="line">    <span class="operator">&lt;</span>limit_number<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>机读（是从from开始读的）</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">FROM &lt;left_table&gt;</span><br><span class="line">ON &lt;join_condition&gt;</span><br><span class="line">&lt;join_type&gt; JOIN &lt;right_table&gt;</span><br><span class="line">WHERE &lt;where_condition&gt;</span><br><span class="line">GROUP BY &lt;group_by_list&gt;</span><br><span class="line">HAVING &lt;having_condition&gt;</span><br><span class="line">SELECT</span><br><span class="line">DISTINCT &lt;select_list&gt;</span><br><span class="line">ORDER BY &lt;order_by_condition&gt;</span><br><span class="line">LIMIT &lt;limit_number&gt;</span><br></pre></td></tr></table></figure>

<p>总结</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653036562614.png"></p>
<h4 id="2-2-2-七种JOIN理论"><a href="#2-2-2-七种JOIN理论" class="headerlink" title="2.2.2 七种JOIN理论"></a>2.2.2 七种JOIN理论</h4><p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653036583891.png"></p>
<p>1.内连接：select * from TableA A INNER JOIN TableB B ON A.key&#x3D;B.key</p>
<p>2.左连接：select * from TableA A LEFT JOIN TableB B ON A.key&#x3D;B.key</p>
<p>3.右连接：select * from TableA A RIGHT JOIN TableB B ON A.key&#x3D;B.key</p>
<p>4.左独有连接：select * from TableA A LEFT JOIN TableB B ON A.key&#x3D;B.key WHERE B.key IS Null</p>
<p>5.右独有连接：select * from TableA A RIGHT JOIN TableB B ON A.key&#x3D;B.key WHERE A.key IS Null</p>
<p>6.全连接：select * from TableA A OUTER JOIN TableB B ON A.key&#x3D;B.key </p>
<p>4.左独右独有连接：select * from TableA A OUTER JOIN TableB B ON A.key&#x3D;B.key WHERE A.key IS NULL OR B.key IS Null</p>
<h4 id="2-2-3-七种JOIN的SQL编写"><a href="#2-2-3-七种JOIN的SQL编写" class="headerlink" title="2.2.3 七种JOIN的SQL编写"></a>2.2.3 七种JOIN的SQL编写</h4><p>准备工作，创建以下表，插入新数据：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE tbl_dept(</span><br><span class="line">	id INT(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">	deptName VARCHAR(30) DEFAULT NULL,</span><br><span class="line">	locAdd VARCHAR(40) DEFAULT NULL,</span><br><span class="line">	PRIMARY KEY(id)</span><br><span class="line">)ENGINE=INNODB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line">CREATE TABLE tbl_emp (</span><br><span class="line">	id INT(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">	NAME VARCHAR(20) DEFAULT NULL,</span><br><span class="line">	deptId INT(11) DEFAULT NULL,</span><br><span class="line">	PRIMARY KEY (id),</span><br><span class="line">	KEY fk_dept_Id (deptId)</span><br><span class="line">	#CONSTRAINT &#x27;fk_dept_Id&#x27; foreign key (&#x27;deptId&#x27;) references &#x27;tbl_dept&#x27;(&#x27;Id&#x27;)</span><br><span class="line">)ENGINE=INNODB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line">INSERT INTO tbl_dept(deptName,locAdd) VALUES(&#x27;RD&#x27;,11);</span><br><span class="line">INSERT INTO tbl_dept(deptName,locAdd) VALUES(&#x27;HR&#x27;,12);</span><br><span class="line">INSERT INTO tbl_dept(deptName,locAdd) VALUES(&#x27;MK&#x27;,13);</span><br><span class="line">INSERT INTO tbl_dept(deptName,locAdd) VALUES(&#x27;MIS&#x27;,14);</span><br><span class="line">INSERT INTO tbl_dept(deptName,locAdd) VALUES(&#x27;FD&#x27;,15);</span><br><span class="line"></span><br><span class="line">INSERT INTO tbl_emp(NAME,deptId) VALUES(&#x27;z3&#x27;,1);</span><br><span class="line">INSERT INTO tbl_emp(NAME,deptId) VALUES(&#x27;z4&#x27;,1);</span><br><span class="line">INSERT INTO tbl_emp(NAME,deptId) VALUES(&#x27;z5&#x27;,1);</span><br><span class="line">INSERT INTO tbl_emp(NAME,deptId) VALUES(&#x27;w5&#x27;,2);</span><br><span class="line">INSERT INTO tbl_emp(NAME,deptId) VALUES(&#x27;w6&#x27;,2);</span><br><span class="line">INSERT INTO tbl_emp(NAME,deptId) VALUES(&#x27;s7&#x27;,3);</span><br><span class="line">INSERT INTO tbl_emp(NAME,deptId) VALUES(&#x27;s8&#x27;,4);</span><br><span class="line">INSERT INTO tbl_emp(NAME,deptId) VALUES(&#x27;s9&#x27;,51);</span><br></pre></td></tr></table></figure>

<p> select * from tbl_dept;</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653369609741.png"></p>
<p>select * from tbl_emp;</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653369648942.png"></p>
<p>执行后的结果： </p>
<p>笛卡尔积：select * from tbl_dept,tbl_emp;</p>
<p>​	5*8&#x3D;40</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653369722928.png"></p>
<p>inner连接  共有的</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tbl_dept a <span class="keyword">inner</span> <span class="keyword">join</span> tbl_emp b <span class="keyword">on</span> a.id<span class="operator">=</span>b.deptId;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653369847030.png"></p>
<p>left连接 共有+独有</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tbl_dept a <span class="keyword">left</span> <span class="keyword">join</span> tbl_emp <span class="keyword">on</span> a.id<span class="operator">=</span>b.deptId;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653369958614.png"></p>
<p>right连接 共有+独有</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tbl_dept a <span class="keyword">right</span> <span class="keyword">join</span> tbl_emp <span class="keyword">on</span> a.id<span class="operator">=</span>b.deptId;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653370054366.png"></p>
<p>left 独有</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tbl_dept a <span class="keyword">left</span> <span class="keyword">join</span> tbl_emp <span class="keyword">on</span> a.id<span class="operator">=</span>b.deptId <span class="keyword">where</span> b.deptid <span class="keyword">is</span> <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653370143836.png"></p>
<p>right独有</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tbl_dept a <span class="keyword">right</span> <span class="keyword">join</span> tbl_emp <span class="keyword">on</span> a.id<span class="operator">=</span>b.deptId <span class="keyword">where</span> a.id <span class="keyword">is</span> <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653370208421.png"></p>
<p>全连接  left 独有+共有+right独有</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tbl_dept a <span class="keyword">full</span> <span class="keyword">outer</span> <span class="keyword">join</span> tbl_emp <span class="keyword">on</span> a.id<span class="operator">=</span>b.deptId;</span><br><span class="line">但MySQL不支持<span class="keyword">full</span> <span class="keyword">join</span>，不过可以换种方法表示</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tbl_dept a <span class="keyword">left</span> <span class="keyword">join</span> tbl_emp <span class="keyword">on</span> a.id<span class="operator">=</span>b.deptId</span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tbl_dept a <span class="keyword">right</span> <span class="keyword">join</span> tbl_emp <span class="keyword">on</span> a.id<span class="operator">=</span>b.deptId;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653370500157.png"></p>
<p>没有公共部分的全连接  left独有+right独有</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tbl_dept a <span class="keyword">full</span> <span class="keyword">outer</span> <span class="keyword">join</span> tbl_emp <span class="keyword">on</span> a.id<span class="operator">=</span>b.deptId <span class="keyword">where</span> a.id <span class="keyword">is</span> <span class="keyword">null</span> <span class="keyword">or</span> b.deptId <span class="keyword">is</span> <span class="keyword">null</span>;</span><br><span class="line">但MySQL不支持<span class="keyword">full</span> <span class="keyword">join</span>，不过可以换种方法表示</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tbl_dept a <span class="keyword">left</span> <span class="keyword">join</span> tbl_emp <span class="keyword">on</span> a.id<span class="operator">=</span>b.deptId <span class="keyword">where</span> b.deptId <span class="keyword">is</span> <span class="keyword">null</span></span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tbl_dept a <span class="keyword">right</span> <span class="keyword">join</span> tbl_emp <span class="keyword">on</span> a.id<span class="operator">=</span>b.deptId <span class="keyword">where</span> a.id <span class="keyword">is</span> <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653370663731.png"></p>
<h3 id="2-3-索引"><a href="#2-3-索引" class="headerlink" title="2.3 索引"></a>2.3 索引</h3><h4 id="2-3-1索引是什么"><a href="#2-3-1索引是什么" class="headerlink" title="2.3.1索引是什么"></a>2.3.1索引是什么</h4><p>MySQL官方对索引的定义为：<strong>索引（Index）是帮助MySQL高效获取数据的数据结构</strong>。可以得到索引的本质：索引是数据结构。</p>
<p>索引的目的在于<strong>提高查询效率</strong>，可以类比字典。</p>
<p>如果要查“mysql”这个单词，我们肯定需要定位到m字母，然后从下往下找到y字母，再找到剩下的sql。</p>
<p>如果没有索引，那么你可能需要逐个逐个寻找，如果我想找到Java开头的单词呢？或者Oracle开头的单词呢？</p>
<p>是不是觉得如果没有索引，这个事情根本无法完成？</p>
<p>你可以简单理解为<strong>“排好序的快速查找数据结构”</strong>。</p>
<ul>
<li><p>详解</p>
<p>在数据之外，数据库系统还维护着满足特定查找算法的数据结构，这些数据结构以某种方式引用(指向）数据，这样就可以在这些数据结构上实现高级查找算法。这种数据结构，就是索引。下图就是一种可能的索引方式示例：</p>
</li>
</ul>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653371811352.png"></p>
<p>左边是数据表，一共有两列七条记录，最左边的是数据记录的物理地址。</p>
<p>为了加快Col2的查找，可以维护一个右边所示的二叉查找树，每个节点分别包含索引键值和一个指向对应数据记录物理地址的指针，这样就可以运用二叉查找在一定的复杂度内获取到相应数据，从而快速的检索出符合条件的记录。</p>
<p>数据本身之外，数据库还维护着一个满足特定查找算法的数据结构，这些数据结构以某种方式指向数据，这样就可以在这些数据结构的基础上实现高级查找算法，这种数据结构就是索引。</p>
<p>一般来说索引本身也很大，不可能全部存储在内存中，因此索引往往以<strong>索引文件</strong>的形式存储的磁盘上。</p>
<p><strong>我们平常所说的索引，如果没有特别指明，都是指B树（多路搜索树，并不一定是二叉的）结构组织的索引</strong>。其中聚集索引，次要索引，覆盖索引，复合索引，前缀索引，唯一索引默认都是使用B+树索引，统称索引。当然，除了B+树这种类型的索引之外，还有哈稀索引(hash index)等。索引的两大功能：排序+查找</p>
<p>一个解决where后面的字段是否查的快，条件上拼装组合；第二个是解决order by排序的时候如何查找的快</p>
<h4 id="2-3-2-索引优劣势"><a href="#2-3-2-索引优劣势" class="headerlink" title="2.3.2 索引优劣势"></a>2.3.2 索引优劣势</h4><ul>
<li><p>优势</p>
<ul>
<li><p>类似大学图书馆建书目索引，<strong>提高数据检索的效率，降低数据库的IO成本</strong>。</p>
</li>
<li><p>通过索引列对数据进行排序，<strong>降低数据排序的成本，降低了CPU的消耗。</strong></p>
</li>
</ul>
</li>
<li><p>劣势</p>
<ul>
<li><p>实际上索引也是一张表，该表保存了主键与索引字段，并指向实体表的记录，所以索引列也是要占用空间的（占空间）</p>
</li>
<li><p>虽然索引大大提高了查询速度，同时却会降低更新表的速度，如对表进行INSERT、UPDATE和DELETE。因为更新表时，MySQL不仅要保存数据，还要保存一下索引文件每次更新添加了索引列的字段，都会调整因为更新所带来的键值变化后的索引信息。</p>
</li>
</ul>
</li>
</ul>
<p>索引只是提高效率的一个因素，如果你的MysQL有大数据量的表，就需要花时间研究建立最优秀的索引，或优化查询。</p>
<p>总结：索引，空间换取时间。</p>
<h4 id="2-3-3-索引分类和建索引命令语句"><a href="#2-3-3-索引分类和建索引命令语句" class="headerlink" title="2.3.3 索引分类和建索引命令语句"></a>2.3.3 索引分类和建索引命令语句</h4><p>MySQL索引分类：</p>
<ul>
<li><p>单值索引：即一个索引只包含单个列，一个表可以有多个单列索引。</p>
</li>
<li><p>唯一索引：索引列的值必须唯一，但允许有空值。unique</p>
</li>
<li><p>复合索引：即一个索引包含多个列。</p>
</li>
</ul>
<p>基本语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">创建</span><br><span class="line"><span class="operator">-</span><span class="keyword">CREATE</span> [<span class="keyword">UNIQUE</span>] INDEX indexName <span class="keyword">ON</span> mytable(columnName(length));<span class="comment">--括号中写一个字段就代表是单值索引，写两个字段就代表是复合索引</span></span><br><span class="line"><span class="operator">-</span><span class="keyword">ALTER</span> mytable <span class="keyword">ADD</span> [<span class="keyword">UNIQUE</span>] INDEX [indexName] <span class="keyword">ON</span> (columnName(length));<span class="comment">--[UNIQUE]写上就代表是唯一索引</span></span><br><span class="line">eg:</span><br><span class="line">    <span class="operator">-</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;&#x27;</span>;<span class="operator">/</span><span class="operator">/</span>查询语句</span><br><span class="line">      <span class="keyword">create</span> index idx_user_name <span class="keyword">on</span> <span class="keyword">user</span>(name);<span class="operator">/</span><span class="operator">/</span>创建索引</span><br><span class="line">      <span class="keyword">create</span> index idx_表名__索引名 <span class="keyword">on</span> 表名（给哪个字段建索引）</span><br><span class="line">    <span class="operator">-</span> 复合</span><br><span class="line">      <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;&#x27;</span> <span class="keyword">and</span> email<span class="operator">=</span><span class="string">&#x27;&#x27;</span>;</span><br><span class="line">      <span class="keyword">create</span> index idx_user_nameEmail <span class="keyword">on</span> <span class="keyword">user</span>(name, email);</span><br><span class="line">  </span><br><span class="line">删除</span><br><span class="line"><span class="operator">-</span><span class="keyword">DROP</span> INDEX [indexName] <span class="keyword">ON</span> mytable;</span><br><span class="line">查看</span><br><span class="line"><span class="operator">-</span><span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> tableName;</span><br><span class="line"><span class="comment">--使用alter命令 - 有四种方式来添加数据表的索引</span></span><br><span class="line"><span class="operator">-</span><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tbl_name <span class="keyword">ADD</span> <span class="keyword">PRIMARY</span> KEY (column_list);：该语句添加一个主键，这意味着索引值必须是唯一的，且不能为<span class="keyword">NULL</span>。</span><br><span class="line"><span class="operator">-</span><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tbl name <span class="keyword">ADD</span> <span class="keyword">UNIQUE</span> index_name (column_list);：这条语句创建索引的值必须是唯一的(除了<span class="keyword">NULL</span>外，<span class="keyword">NULL</span>可能会出现多次)。</span><br><span class="line"><span class="operator">-</span><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tbl_name <span class="keyword">ADD</span> INDEX index_name (column_list);：添加普通索引，索引值可出现多次。</span><br><span class="line"><span class="operator">-</span><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tbl_name <span class="keyword">ADD</span> FULLTEXT index_name (column_list);：该语句指定了索引为FULLTEXT，用于全文索引。</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653377280745.png"></p>
<h4 id="2-3-4-索引结构与检索原理"><a href="#2-3-4-索引结构与检索原理" class="headerlink" title="2.3.4 索引结构与检索原理"></a>2.3.4 索引结构与检索原理</h4><p>MySQL索引结构</p>
<ul>
<li><p>BTree索引</p>
</li>
<li><p>Hash索引(了解，知道名字)</p>
</li>
<li><p>full-text全文索引(了解，知道名字)</p>
</li>
<li><p>R-Tree索引(了解，知道名字)</p>
</li>
</ul>
<p>BTree索引检索原理<br><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653377477834.png"></p>
<p>初始化介绍</p>
<p>一颗b+树，浅蓝色的块我们称之为一个磁盘块，可以看到每个磁盘块包含几个数据项（深蓝色所示）和指针（黄色所示),如磁盘块1包含数据项17和35，包含指针P1、P2、P3,<br>P1表示小于17的磁盘块，P2表示在17和35之间的磁盘块，P3表示大于35的磁盘块。</p>
<p>真实的数据存在于叶子节点即3、5、9、10、13、15、28、29、36、60、75、79、90、99。</p>
<p>非叶子节点只不存储真实的数据，只存储指引搜索方向的数据项，如17、35并不真实存在于数据表中。</p>
<p>查找过程</p>
<p>如果要查找数据项29，那么首先会把磁盘块1由磁盘加载到内存，此时发生一次IO。在内存中用二分查找确定29在17和35之间，锁定磁盘块1的P2指针，内存时间因为非常短（相比磁盘的IO）可以忽略不计，通过磁盘块1的P2指针的磁盘地址把磁盘块3由磁盘加载到内存，发生第二次IO，29在26和30之间，锁定磁盘块3的P2指针，通过指针加载磁盘块8到内存，发生第三次IO，同时内存中做二分查找找到29，结束查询，总计三次IO。</p>
<p>真实的情况是，3层的b+树可以表示上百万的数据，如果上百万的数据查找只需要三次IO，性能提高将是巨大的，如果没有索引，每个数据项都要发生一次IO，那么总共需要百万次的IO，显然成本非常非常高。</p>
<h4 id="2-3-5-哪些情况适合建索引"><a href="#2-3-5-哪些情况适合建索引" class="headerlink" title="2.3.5 哪些情况适合建索引"></a>2.3.5 哪些情况适合建索引</h4><ul>
<li>主键自动建立唯一索引 primary</li>
<li>频繁作为查询条件的字段应该创建索引</li>
<li>查询中与其它表关联的字段，外键关系建立索引（tbl_dept中的deptId与tbl_emp中的id）</li>
<li>频繁更新的字段不适合创建索引，因为每次更新不单单是更新了记录还会更新索引</li>
<li>Where条件里用不到的字段不创建索引</li>
<li>单键&#x2F;组合索引的选择问题，who?(在高并发下倾向创建<strong>组合索引</strong>)</li>
<li>查询中排序的字段，排序字段若通过索引去访问将大大提高排序速度(order by)</li>
<li>查询中统计或者分组字段(group by)</li>
</ul>
<h4 id="2-3-6-哪些情况不适合建索引"><a href="#2-3-6-哪些情况不适合建索引" class="headerlink" title="2.3.6 哪些情况不适合建索引"></a>2.3.6 哪些情况不适合建索引</h4><ul>
<li>表记录太少</li>
<li>经常增删改的表(虽然索引大大提高了查询速度，同时却会降低更新表的速度，如对表进行INSERT、UPDATE和DELETE。因为更新表时，MySQL不仅要保存数据，还要保存一下索引文件每次更新添加了索引列的字段，都会调整因为更新所带来的键值变化后的索引信息。)</li>
<li>数据重复且分布平均的表字段，因此应该只为最经常查询和最经常排序的数据列建立索引。注意，如果某个数据列包含许多重复的内容，为它建立索引就没有太大的实际效果。</li>
</ul>
<p>假如一个表有10万行记录，有一个字段A只有T和F两种值，且每个值的分布概率大约为50%，那么对这种表A字段建索引一般不会提高数据库的查询速度。</p>
<p>索引的选择性是指索引列中不同值的数目与表中记录数的比。如果一个表中有2000条记录，表索引列有1980个不同的值，那么这个索引的选择性就是1980&#x2F;2000&#x3D;0.99。一个索引的选择性越接近于1，这个索引的效率就越高。</p>
<h3 id="2-4性能分析前提知识"><a href="#2-4性能分析前提知识" class="headerlink" title="2.4性能分析前提知识"></a>2.4性能分析前提知识</h3><h4 id="2-4-1-MySQL-Query-Optimizer"><a href="#2-4-1-MySQL-Query-Optimizer" class="headerlink" title="2.4.1 MySQL Query Optimizer"></a>2.4.1 MySQL Query Optimizer</h4><p>MySQL Query Optimizer ：mysql的查询优化器</p>
<p>​	Mysql中有专门负责优化SELECT语句的优化器模块，主要功能:通过计算分析系统中收集到的统计信息，为客户端请求的Query提供他认为最优的执行计划（他认为最优的数据检索方式，但不见得是DBA认为是最优的,这部分最耗费时间）  他指的是mysql</p>
<p>​	当客户端向MySQL请求一条Query，命令解析器模块完成请求分类，区别出是SELECT并转发给MySQL Query Optimizer时，MySQL Query Optimizer首先会对整条Query进行优化，处理掉一些常量表达式的预算直接换算成常量值。并对Query中的查询条件进行简化和转换，如去掉一些无用或显而易见的条件、结构调整等。然后分析Query 中的 Hint信息(如果有），看显示Hint信息是否可以完全确定该Query的执行计划。如果没有Hint 或Hint信息还不足以完全确定执行计划，则会读取所涉及对象的统计信息，根据Query进行写相应的计算分析，然后再得出最后的执行计划。</p>
<h4 id="2-4-2-MySQL常见瓶颈"><a href="#2-4-2-MySQL常见瓶颈" class="headerlink" title="2.4.2 MySQL常见瓶颈"></a>2.4.2 MySQL常见瓶颈</h4><ul>
<li><p>​	CPU：CPU在饱和的时候一般发生在数据装入内存或从磁盘上读取数据时候</p>
</li>
<li><p>​	IO：磁盘I&#x2F;O瓶颈发生在装入数据远大于内存容量的时候</p>
</li>
<li><p>​	服务器硬件的性能瓶颈：top，free，iostat和vmstat来查看系统的性能状态</p>
</li>
</ul>
<h4 id="2-4-3-explain使用简介（id、type、key、rows、extra重要）"><a href="#2-4-3-explain使用简介（id、type、key、rows、extra重要）" class="headerlink" title="2.4.3 explain使用简介（id、type、key、rows、extra重要）"></a>2.4.3 explain使用简介（id、type、key、rows、extra重要）</h4><p>explain是什么</p>
<ul>
<li>使用EXPLAIN关键字可以模拟优化器执行SQL查询语句，从而知道MySQL是如何处理你的SQL语句的。分析你的查询语句或是表结构的性能瓶颈。</li>
</ul>
<p>官网地址</p>
<p>explain能干嘛</p>
<ul>
<li>表的读取顺序（id）</li>
<li>数据读取操作的操作类型（select_type）</li>
<li>哪些索引可以使用</li>
<li>哪些索引被实际使用（key）</li>
<li>表之间的引用</li>
<li>每张表有多少行被优化器查询（rows）</li>
</ul>
<p>怎么玩</p>
<ul>
<li><p>explain + sql语句</p>
</li>
<li><p>执行计划包含的信息</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653380124763.png"></p>
</li>
</ul>
<p>表头如下：</p>
<p>| id | select_type | table |  type | possible_keys | key | key_len | ref | rows |Extra |</p>
<h5 id="explain之id介绍（表的读取顺序）"><a href="#explain之id介绍（表的读取顺序）" class="headerlink" title="explain之id介绍（表的读取顺序）"></a>explain之id介绍（表的读取顺序）</h5><p>select查询的序列号，包含一组数字，表示查询中执行select子句或操作表的顺序</p>
<p>三种情况：</p>
<ul>
<li><p>id相同，执行顺序由上至下</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653382018457.png"></p>
<p>顺序是t1,t3,t2</p>
</li>
<li><p>id不同，如果是子查询，id的序号会递增，id值越大优先级越高，越先被执行</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653382073692.png"></p>
<p>subquery是子查询  顺序是t3,t2,t1(得先执行里面的再执行外面的，从里层一层一层的冲出)</p>
</li>
<li><p>id相同不同，同时存在</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653382179065.png"></p>
<p> id如果相同，可以认为是一组，从上往下顺序执行；在所有组中，id值越大，优先级越高，越先执行，衍生&#x3D;DERIVED    顺序是t3先执行，执行的结果别名是s1(derived2是从id为2的表结果衍生的),再执行s1,最后t2</p>
</li>
</ul>
<p><strong>小结</strong></p>
<p>id越大越先查询</p>
<h5 id="explain之select-type和table介绍"><a href="#explain之select-type和table介绍" class="headerlink" title="explain之select_type和table介绍"></a>explain之select_type和table介绍</h5><p>select_type：查询的类型，主要是用于区别普通查询、联合查询、子查询等的复杂查询。</p>
<p>select_type有哪些？</p>
<ul>
<li><p>SIMPLE - 简单的select查询,查询中不包含子查询或者UNION。</p>
</li>
<li><p>PRIMARY - 查询中若包含任何复杂的子部分，最外层查询则被标记为。</p>
</li>
<li><p>SUBQUERY - 在SELECT或WHERE列表中包含了子查询。</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653382073692.png"></p>
</li>
<li><p>DERIUED - 在FROM列表中包含的子查询被标记为DERIVED（衍生）MySQL会递归执行这些子查询，把结果放在临时表里。</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653382179065.png"></p>
</li>
<li><p>UNION - 若第二个SELECT出现在UNION之后，则被标记为UNION；若UNION包含在FROM子句的子查询中外层SELECT将被标记为：DERIVED。</p>
</li>
<li><p>UNION RESULT - 从UNION表获取结果的SELECT。</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653386642852.png"></p>
</li>
</ul>
<p>table：显示这一行的数据是关于哪张表的。</p>
<h5 id="explain之type介绍"><a href="#explain之type介绍" class="headerlink" title="explain之type介绍"></a>explain之type介绍</h5><p>访问类型排列</p>
<p>type显示的是访问类型，是较为重要的一个指标，结果值从最好到最坏依次是：</p>
<p>system &gt; const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range &gt; index &gt;ALL</p>
<p><strong>system&gt;const&gt;eq_ref&gt;ref&gt;range&gt;index&gt;ALL</strong></p>
<p>一般来说，得保证查询至少达到range级别，最好能达到ref。</p>
<p>详细说明</p>
<ul>
<li><p>system：表只有一行记录（等于系统表），这是const类型的特列，平时不会出现，这个也可以忽略不计。</p>
</li>
<li><p>const：表示通过索引一次就找到了，const用于比较primary key或者unique索引（唯一索引）。因为只匹配一行数据，所以很快如将主键置于where列表中，MySQL就能将该查询转换为一个常量。</p>
</li>
</ul>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653390274454.png"></p>
<p>该查询语句中有子查询（括号里面的），所以先执行t1 ,DeRIVED是衍生查询，primary是最外层的查询。执行了t1得到了d1.id&#x3D;1已经写死了，表明数据只有一条，是一个常量，所以t1的那行的type访问类型是const,得到了d1是一行记录，它的那行的type访问类型是system</p>
<ul>
<li>eq_ref：唯一性索引扫描，对于每个索引键，<strong>表中只有一条记录与之匹配</strong>。常见于主键或唯一索引扫描。选择本地图片</li>
</ul>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653396275388.png"></p>
<ul>
<li><p>ref：非唯一性索引扫描，返回匹配某个单独值的所有行，本质上也是一种索引访问，它返回所有匹配某个单独值的行，然而，它可能会找到多个符合条件的行，所以他应该属于查找和扫描的混合体。 </p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653396348339.png"></p>
<p>建了两种索引(col1,col2),在t1表中查询索引为ac的数据（ac是个固定的值）</p>
</li>
<li><p>range：只检索给定范围的行,使用一个索引来选择行。key列显示使用了哪个索引一般就是在你的where语句中出现了between、&lt;、&gt;、in等的查询。这种范围扫描索引扫描比全表扫描要好，因为它只需要开始于索引的某一点，而结束语另一点，不用扫描全部索引。</p>
</li>
</ul>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653396373670.png"></p>
<ul>
<li><p>index：Full Index Scan，index与ALL区别为index类型只遍历索引树。这通常比ALL快，因为索引文件通常比数据文件小（也就是说虽然all和Index都是读全表，但index是从索引中读取的，而all是从硬盘中读的）。 </p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653397170835.png"></p>
<p>id是主键索引，要从t1表中获取id的信息，刚好id就是索引</p>
</li>
<li><p><strong>all</strong>：Full Table Scan，将遍历全表以找到匹配的行。 </p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653396429747.png"></p>
</li>
</ul>
<p> 备注：一般来说，得保证查询至少达到range级别，最好能达到ref。 </p>
<h5 id="explain之possible-keys和key介绍"><a href="#explain之possible-keys和key介绍" class="headerlink" title="explain之possible_keys和key介绍"></a>explain之possible_keys和key介绍</h5><p>possible_keys</p>
<ul>
<li>显示可能应用在这张表中的索引（理论），一个或多个。查询涉及到的字段火若存在索引，则该索引将被列出，但不一定被查询实际使用。</li>
</ul>
<p>key</p>
<ul>
<li>实际使用的索引（实际）。如果为NULL，则没有使用索引</li>
</ul>
<p>查询中若使用了覆盖索引，则该索引仅出现在key列表中</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653456682966.png"></p>
<p>possibles_keys可能使用的索引为null,但实际上的key也就是实际使用索引是idx_col1_col2,这条语句的type是index,说明是存在索引的，是覆盖索引，索引的名字与要查的字段顺序、字母一样，就直接从索引中查询了</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653456914665.png"></p>
<p>possibles_keys可能使用的索引为null,但实际上的key也就是实际使用索引也是null，说明索引根本没建。没建索引统统都是全表扫描</p>
<h5 id="explain之key-len介绍"><a href="#explain之key-len介绍" class="headerlink" title="explain之key_len介绍"></a>explain之key_len介绍</h5><p>表示索引中使用的字节数，可通过该列计算查询中使用的索引的长度。在不损失精确性的情况下，长度越短越好</p>
<p>key_len显示的值为索引字段的最大可能长度，<strong>并非实际使用长度</strong>，即key_len是根据表定义计算而得，不是通过表内检索出</p>
<p>（同样的结果，key_len使用的越少越好）</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653457440411.png"></p>
<p>加了条件得出了同样的结果，key_len使用的越少越好</p>
<p>ref：非唯一性索引扫描，返回匹配某个单独值的所有行</p>
<h5 id="explain之ref介绍"><a href="#explain之ref介绍" class="headerlink" title="explain之ref介绍"></a>explain之ref介绍</h5><p>显示索引的哪一列被使用了，如果可能的话，是一个常数。哪些列或常量被用于查找索引列上的值。</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653459345827.png"></p>
<p>先执行t1,是执行t1.other_column&#x3D;’ ‘,ref：非唯一性索引扫描，返回匹配某个单独值的所有行，结果是一个常量，索引ref使用了这个常量是const;</p>
<p>再执行t3,t2,是外键关系（t1.id&#x3D;t2.id and t1.id&#x3D;t3.id）,实际上用到的索引是primary,t3的ref是test库的t1.id,t2的ref是test库的t1.id</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653455666131.png"></p>
<p>先执行t2,t2是全表扫描，理论上没有用到索引，实际上也没有用上索引，ref为null;再执行t1,理论上有用到索引，实际上也用上索引,索引字段的最大可能长度26,ref是两个用法，一个是主外键连接(t1.col&#x3D;t2.col1)是引用了shared库中的t2表的col1字段,另外一个是t1.col2&#x3D;‘ac’这是个常量</p>
<p>由key_len可知t1表的idx_col1_col2被充分使用，col1匹配t2表的col1，col2匹配了一个常量，即 ‘ac’。</p>
<p>查询中与其它表关联的字段，外键关系建立索引（t1.col1&#x3D;t2.col1）就是shared.t2.col1</p>
<h5 id="explain之rows介绍"><a href="#explain之rows介绍" class="headerlink" title="explain之rows介绍"></a>explain之rows介绍</h5><p>根据表统计信息及索引选用情况，大致估算出找到所需的记录所需要读取的行数。</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653461018349.png"></p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653455687808.png"></p>
<p>建了复合索引，只需要读取143行。</p>
<h5 id="explain之Extra介绍"><a href="#explain之Extra介绍" class="headerlink" title="explain之Extra介绍"></a>explain之Extra介绍</h5><p>包含不适合在其他列中显示但十分重要的额外信息。</p>
<h6 id="Using-filesort（坏的）"><a href="#Using-filesort（坏的）" class="headerlink" title="Using filesort（坏的）"></a><strong>Using filesort</strong>（坏的）</h6><p>说明mysql会对数据使用一个外部的索引排序，而不是按照表内的索引顺序进行读取。MySQL中无法利用索引完成的排序操作称为”文件排序”</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653455708053.png"></p>
<p>第一个出现了文件排序(using sort),因为索引是idx_col1_col2_col3是个复合索引，尽量使按照索引顺序去排序的，但order by col3,没有用上col2，梯子断了，就内部使用了文件排序。存在文件排序不好要优化。</p>
<h6 id="Using-temporary（更坏的）"><a href="#Using-temporary（更坏的）" class="headerlink" title="Using temporary（更坏的）"></a><strong>Using temporary</strong>（更坏的）</h6><p>使了用临时表保存中间结果，MysQL在对查询结果排序时使用临时表。常见于排序order by和分组查询group by。临时表很伤系统的性能，因为临时表要搬数据，用完后再将临时表回收，数据库内部自己折腾。</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653455726482.png"></p>
<p>要不就不建索引，要建了索引排序用group by排序，group by 尽量跟索引的个数、顺序一样，不然容易产生using temporary 和using filesort</p>
<h6 id="Using-index（好的）"><a href="#Using-index（好的）" class="headerlink" title="Using index（好的）"></a>Using index（好的）</h6><p>表示相应的select操作中使用了覆盖索引（Covering Index），避免访问了表的数据行，效率不错！</p>
<p>如果同时出现using where，表明索引被用来执行索引键值的查找；</p>
<p>如果没有同时出现using where，表明索引用来读取数据而非执行查找动作。</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653550201827.png"></p>
<p>用的索引是idx_col1_col2,查询的内容是col2,索引与要查的部分重合匹配。</p>
<p>如果同时出现using where，表明索引被用来执行索引键值的查找；</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653550211030.png"></p>
<p>如果没有同时出现using where，表明索引用来读取数据而非执行查找动作。</p>
<p>覆盖索引（Covering Index）,一说为索引覆盖。（建了三个字段的复合索引col1、col2、col3，select查的不是*，也不是1，2，3，等，刚好是索引的三字段col1、col2、col3或者部分，个数和顺序一样就是覆盖索引）</p>
<p>理解方式一：就是select的数据列只用从索引中就能够取得，不必读取数据行，MySQL可以利用索引返回select列表中的字段，而不必根据索引再次读取数据文件,换句话说<strong>查询列要被所建的索引覆盖</strong>（）。</p>
<p>理解方式二：索引是高效找到行的一个方法，但是一般数据库也能使用索引找到一个列的数据，因此它不必读取整个行。毕竟索引叶子节点存储了它们索引的数据；当能通过读取索引就可以得到想要的数据，那就不需要读取行了。一个索引包含了（或覆盖了）满足查询结果的数据就叫做覆盖索引。</p>
<p>注意：</p>
<p>如果要使用覆盖索引，一定要注意select列表中只取出需要的列，不可select*，因为</p>
<p>如果将所有字段一起做索引会导致索引文件过大，查询性能下降。</p>
<p><strong>Using where</strong></p>
<p>表明使用了where过滤。</p>
<p><strong>Using join buffer</strong></p>
<p>使用了连接缓存。</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653915738562.png"></p>
<p><strong>impossible where</strong></p>
<p>where子句的值总是false，不能用来获取任何元组。</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653551313163.png"></p>
<p>不可能有人既叫Iuly又有人叫z3</p>
<p><strong>select tables optimized away</strong></p>
<p>在没有GROUPBY子句的情况下，基于索引优化MIN&#x2F;MAX操作，或者对于MyISAM存储引擎优化COUNT(*)操作，不必等到执行阶段再进行计算，查询执行计划生成的阶段即完成优化。</p>
<p><strong>distinct</strong></p>
<p>优化distinct操作，在找到第一匹配的元组后即停止找同样值的动作。</p>
<h5 id="练习case"><a href="#练习case" class="headerlink" title="练习case"></a>练习case</h5><p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653552315054.png"></p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653552354931.png"></p>
<h5 id="索引单表优化案例"><a href="#索引单表优化案例" class="headerlink" title="索引单表优化案例"></a>索引单表优化案例</h5><p>建表SQL</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> article(</span><br><span class="line">	id <span class="type">INT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT,</span><br><span class="line">	author_id <span class="type">INT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	category_id <span class="type">INT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	views <span class="type">INT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	comments <span class="type">INT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	title <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	content TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> article(author_id,category_id,views,comments,title,content)</span><br><span class="line"><span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1&#x27;</span>),</span><br><span class="line">(<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;2&#x27;</span>),</span><br><span class="line">(<span class="number">1</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;3&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653653342347.png"></p>
<p>案例**</p>
<p>查询category_id为1且comments 大于1的情况下，views最多的author_id。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id,author_id <span class="keyword">from</span> article <span class="keyword">where</span> category_id<span class="operator">=</span><span class="number">1</span> <span class="keyword">AND</span> comments<span class="operator">&gt;</span><span class="number">1</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> views <span class="keyword">DESC</span> LIMIT <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p> 查看，发现type是ALL是全表扫描，没有索引，还using filesort文件排序，要优化</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653654035351.png"></p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653654191153.png"></p>
<p>主键id自动建立唯一索引 primary</p>
<p>优化：</p>
<ul>
<li><p>建立索引，因为是Where条件里常做索引，所以建立category_id、comments、views的索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_article_ccv <span class="keyword">on</span> article(category_id,comments,views);</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653654587501.png"></p>
</li>
</ul>
<p>​       再次查询explain select id,author_id from article where category_id&#x3D;1 AND comments&gt;1 ORDER BY views DESC LIMIT 1;</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653654692572.png"></p>
<p>发现type不再是全表查询，而是range范围(因为 comments&gt;1 )，使用了索引，但还是出现using filesort</p>
<p>但explain select id,author_id from article where category_id&#x3D;1 AND comments&#x3D;1 ORDER BY views DESC LIMIT 1;</p>
<p>ref是非唯一性索引；</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653654898064.png"></p>
<p>出现using filesort 因为comments&gt;1出现了范围导致索引失效，索引idx_article_ccv,c正常，第二个c断了，导致 索引views用不上，而comments&#x3D;1是常量，索引都用上了，就不需要mysql自己进行文件排序了。</p>
<p>本次建的索引不合适，所以要删掉本索引,重建索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> index idx_article_ccv <span class="keyword">on</span> article;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653656361646.png"></p>
<p>删除索引后还是全表扫描，using filesort</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653656705713.png"></p>
<p>缘由</p>
<p>type变成了range，这是可以忍受的。但是extra里使用Using filesort仍是无法接受的。</p>
<p>但是我们已经建立了索引，为啥没用呢？</p>
<p>这是因为按照BTree索引的工作原理，先排序category_id，如果遇到相同的category_id则再排序comments,如果遇到相同的comments 则再排序views。</p>
<p>当comments字段在联合索引里处于中间位置时，因comments &gt; 1条件是一个范围值(所谓range)，MySQL无法利用索引再对后面的views部分进行检索，即range类型查询字段后面的索引无效。</p>
<p>改进</p>
<p>跟上次创建索引相比，这次不为comments字段创建索引。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_article_cv <span class="keyword">on</span> article(category_id,views);</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653656907686.png"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> id,author_id <span class="keyword">from</span> article <span class="keyword">where</span> category_id<span class="operator">=</span><span class="number">1</span> <span class="keyword">AND</span> comments<span class="operator">&gt;</span><span class="number">1</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> views <span class="keyword">DESC</span> LIMIT <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653656941038.png"></p>
<p>解决了ALL以及using sort ,索引既在查询也在排序中使用上了。 可以看到，type变为了ref，Extra中的Using filesort也消失了，结果非常理想。 </p>
<h5 id="索引两表优化案例"><a href="#索引两表优化案例" class="headerlink" title="索引两表优化案例"></a>索引两表优化案例</h5><p>新建SQL</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> class(</span><br><span class="line">	id <span class="type">INT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">	card <span class="type">INT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	<span class="keyword">PRIMARY</span> KEY(id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> book(</span><br><span class="line">	bookid <span class="type">INT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">	card <span class="type">INT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	<span class="keyword">PRIMARY</span> KEY(bookid)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> class(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> class(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> class(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> class(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> class(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> class(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> class(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> class(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> class(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> class(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> class(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> class(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> class(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> class(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> class(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> class(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> class(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> class(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> class(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> class(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> class(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br></pre></td></tr></table></figure>

<p> 创建后的结果： </p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653912624309.png"></p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653912640293.png"></p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653912679535.png"></p>
<p> 开始explain分析 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> class <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> book <span class="keyword">ON</span> class.card <span class="operator">=</span> book.card;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653913333880.png"></p>
<p>type都是all，需要优化。</p>
<p>为book.card创建索引</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table `book` add index y(`card`);</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653913374637.png"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> class <span class="keyword">left</span> <span class="keyword">join</span> book <span class="keyword">on</span> class.card<span class="operator">=</span>book.card;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653913416910.png"></p>
<p>可以看到第二行的type变为了ref，rows也变少了，优化比较明显。这是由左连接特性决定的。LEFT JOIN条件用于确定如何从右表搜索行，左边一定都有，所以右边是我们的关键点，一定需要在右表建立索引。</p>
<p>删除为book.card创建索引</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drop index y on book;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653913845835.png"></p>
<p> 为class.card创建索引 (左表)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> `class` <span class="keyword">add</span> index y(`card`);</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653913901216.png"></p>
<p> 再次explain分析 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> class <span class="keyword">left</span> <span class="keyword">join</span> book <span class="keyword">on</span> class.card<span class="operator">=</span>book.card;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653913939196.png"></p>
<p> 可见右边是我们的关键点，要想优化需要在右表建立索引。 </p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653914023485.png"></p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653914399156.png"></p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653914571846.png"></p>
<p><strong>小结</strong></p>
<p>索引两表优化，左连接右表建索引，右连接左表建索引。</p>
<p>左连接建右表的索引，右连接建左表的索引</p>
<h5 id="索引三表优化案例"><a href="#索引三表优化案例" class="headerlink" title="索引三表优化案例"></a>索引三表优化案例</h5><p>新建SQL</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> phone(</span><br><span class="line">	phoneid <span class="type">INT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">	card <span class="type">INT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	<span class="keyword">PRIMARY</span> KEY(phoneid)</span><br><span class="line">)ENGINE<span class="operator">=</span>INNODB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>(RAND()<span class="operator">*</span><span class="number">20</span>)));</span><br></pre></td></tr></table></figure>

<p> 建后效果 </p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653914763966.png"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> class <span class="keyword">inner</span> <span class="keyword">join</span> book <span class="keyword">on</span> class.card<span class="operator">=</span>book.card <span class="keyword">inner</span> <span class="keyword">join</span> phone <span class="keyword">on</span> book.card<span class="operator">=</span>phone.card;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653915738562.png"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> class <span class="keyword">left</span> <span class="keyword">join</span> book <span class="keyword">on</span> class.card<span class="operator">=</span>book.card <span class="keyword">left</span> <span class="keyword">join</span> phone <span class="keyword">on</span> book.card<span class="operator">=</span>phone.card;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653915895863.png"></p>
<p> 为phone.card和book.card创建新的索引。 因为对于前一个leftJoin是book是右表，得出的结果还要与phone再进行leftJoin，所以phone也是右表</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653916109805.png"></p>
<p>再次explain</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> class <span class="keyword">left</span> <span class="keyword">join</span> book <span class="keyword">on</span> class.card<span class="operator">=</span>book.card <span class="keyword">left</span> <span class="keyword">join</span> phone <span class="keyword">on</span> book.card<span class="operator">=</span>phone.card;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653916169926.png"></p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653916196195.png"></p>
<p>结论</p>
<h5 id="Join语句的优化"><a href="#Join语句的优化" class="headerlink" title="Join语句的优化"></a>Join语句的优化</h5><p>尽可能减少Join语句中的NestedLoop的循环总次数：“永远用小结果集驱动大的结果集”。</p>
<p>优先优化NestedLoop的内层循环，保证Join语句中被驱动表上Join条件字段已经被索引。</p>
<p>当无法保证被驱动表的Join条件字段被索引且内存资源充足的前提下，不要太吝惜JoinBuffer的设置。</p>
<h5 id="索引失效"><a href="#索引失效" class="headerlink" title="索引失效"></a>索引失效</h5><h6 id="索引失效1-跳过复合索引中间列"><a href="#索引失效1-跳过复合索引中间列" class="headerlink" title="索引失效1-跳过复合索引中间列"></a>索引失效1-跳过复合索引中间列</h6><p>索引失效（应该避免）</p>
<ul>
<li>最佳左前缀法则 - 如果索引了多列，要遵守最左前缀法则。指的是查询从索引的最左前列开始并且不跳过复合索引中间列。</li>
<li>不在索引列上做任何操作（计算、函数、（自动or手动）类型转换），会导致索引失效而转向全表扫描。</li>
<li>存储引擎不能使用索引中范围条件右边的列。</li>
<li>尽量使用覆盖索引（只访问索引的查询（索引列和查询列一致）），减少select *。</li>
<li>mysql在使用不等于（!&#x3D;或者&lt;&gt;）的时候无法使用索引会导致全表扫描。</li>
<li>is null, is not null 也无法使用索引。</li>
<li>like以通配符开头（’%abc…’），mysql索引失效会变成全表扫描的操作。</li>
<li>字符串不加单引号索引失效。</li>
<li>少用or，用它来连接时会索引失效。</li>
</ul>
<p>1.全值匹配我最爱</p>
<p>新建SQL</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> staffs(</span><br><span class="line">	id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT,</span><br><span class="line">	`name` <span class="type">VARCHAR</span>(<span class="number">24</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span><span class="string">&#x27;&#x27;</span> COMMENT<span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">	`age` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT<span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">	`pos` <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span><span class="string">&#x27;&#x27;</span> COMMENT<span class="string">&#x27;职位&#x27;</span>,</span><br><span class="line">	`add_time` <span class="type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT<span class="string">&#x27;入职时间&#x27;</span></span><br><span class="line">)CHARSET utf8 COMMENT<span class="string">&#x27;员工记录表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> staffs(`name`,`age`,`pos`,`add_time`) <span class="keyword">VALUES</span>(<span class="string">&#x27;z3&#x27;</span>,<span class="number">22</span>,<span class="string">&#x27;manager&#x27;</span>,NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> staffs(`name`,`age`,`pos`,`add_time`) <span class="keyword">VALUES</span>(<span class="string">&#x27;July&#x27;</span>,<span class="number">23</span>,<span class="string">&#x27;dev&#x27;</span>,NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> staffs(`name`,`age`,`pos`,`add_time`) <span class="keyword">VALUES</span>(<span class="string">&#x27;2000&#x27;</span>,<span class="number">23</span>,<span class="string">&#x27;dev&#x27;</span>,NOW());</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> staffs <span class="keyword">ADD</span> INDEX index_staffs_nameAgePos(`name`,`age`,`pos`);</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653918280393.png"></p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653918388454.png"></p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653918460025.png"></p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653918492215.png"></p>
<p>说明只有name存在，查询从索引的最左侧也就是name开始，就应用了索引</p>
<p>那么不查询中间的索引</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653918690439.png"></p>
<p> <strong>最佳左前缀法则</strong> - 如果索引了多列，要遵守最左前缀法则。指的是查询从索引的最左前列开始并且<strong>不跳过索引中的列</strong> </p>
<h6 id="索引失效2-索引列上做额外操作"><a href="#索引失效2-索引列上做额外操作" class="headerlink" title="索引失效2-索引列上做额外操作"></a>索引失效2-索引列上做额外操作</h6><p>不在索引列上做任何操作（计算、函数、（自动or手动）类型转换），会导致索引失效而转向全表扫描。</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653919528607.png"></p>
<h6 id="索引失效3-限定复合索引某列的范围"><a href="#索引失效3-限定复合索引某列的范围" class="headerlink" title="索引失效3-限定复合索引某列的范围"></a>索引失效3-限定复合索引某列的范围</h6><p>存储引擎不能使用索引中<strong>范围条件</strong>右边的列（我理解为限定复合索引某字段的范围会时索引失效，也就是&gt;，&lt;，between…and…谨慎用在复合索引某字段）。</p>
<p> 由<code>age=25</code>变成<code>age&gt;25</code>后，type从ref变成range。 </p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653920022231.png"></p>
<h6 id="索引失效4-select"><a href="#索引失效4-select" class="headerlink" title="索引失效4-select *"></a>索引失效4-select *</h6><p>尽量使用覆盖索引（只访问索引的查询（索引列和查询列一致）），减少select *</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653920617095.png"></p>
<h6 id="索引失效5-x3D-或者-lt-gt"><a href="#索引失效5-x3D-或者-lt-gt" class="headerlink" title="索引失效5-!&#x3D;或者&lt;&gt;"></a>索引失效5-!&#x3D;或者&lt;&gt;</h6><p>mysql在使用不等于（!&#x3D;或者&lt;&gt;）的时候无法使用索引会导致全表扫描。</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653984661036.png"></p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653984705845.png"></p>
<h6 id="索引失效6-is-null或者is-not-null"><a href="#索引失效6-is-null或者is-not-null" class="headerlink" title="索引失效6-is null或者is not null"></a>索引失效6-is null或者is not null</h6><p>is null, is not null 也无法使用索引</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653984918827.png"></p>
<p> Extra打印为Impossible WHERE，是因为我们在创建staffs表，设置name字段的属性为not null。 </p>
<h6 id="索引失效7-like以通配符-开头字符串"><a href="#索引失效7-like以通配符-开头字符串" class="headerlink" title="索引失效7-like以通配符%开头字符串"></a>索引失效7-like以通配符%开头字符串</h6><p>like以通配符%开头（’%abc…’），mysql索引失效会变成全表扫描的操作。</p>
<p>口诀：%like加右边 避免了索引失效</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1653985397439.png"></p>
<p>like查询是个范围</p>
<p><strong>问题：解决like ‘%字符串%’时索引不被使用的方法？</strong></p>
<p>新建SQL</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tbl_user`(</span><br><span class="line">	`id` <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">	`name` <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	`age`<span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	`email` <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	<span class="keyword">PRIMARY</span> KEY(`id`)</span><br><span class="line">)ENGINE<span class="operator">=</span>INNODB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tbl_user(`name`,`age`,`email`)<span class="keyword">VALUES</span>(<span class="string">&#x27;1aa1&#x27;</span>,<span class="number">21</span>,<span class="string">&#x27;a@163.com&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tbl_user(`name`,`age`,`email`)<span class="keyword">VALUES</span>(<span class="string">&#x27;2bb2&#x27;</span>,<span class="number">23</span>,<span class="string">&#x27;b@163.com&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tbl_user(`name`,`age`,`email`)<span class="keyword">VALUES</span>(<span class="string">&#x27;3cc3&#x27;</span>,<span class="number">24</span>,<span class="string">&#x27;c@163.com&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tbl_user(`name`,`age`,`email`)<span class="keyword">VALUES</span>(<span class="string">&#x27;4dd4&#x27;</span>,<span class="number">26</span>,<span class="string">&#x27;d@163.com&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654084366356.png"></p>
<p> 创建索引前，先看看以下explain： </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> NAME,age <span class="keyword">FROM</span> tbl_user <span class="keyword">WHERE</span> NAME <span class="keyword">LIKE</span> <span class="string">&#x27;%aa%&#x27;</span>;</span><br><span class="line"></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> id <span class="keyword">FROM</span> tbl_user <span class="keyword">WHERE</span> NAME <span class="keyword">LIKE</span> <span class="string">&#x27;%aa%&#x27;</span>;</span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> NAME <span class="keyword">FROM</span> tbl_user <span class="keyword">WHERE</span> NAME <span class="keyword">LIKE</span> <span class="string">&#x27;%aa%&#x27;</span>;</span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> age <span class="keyword">FROM</span> tbl_user <span class="keyword">WHERE</span> NAME <span class="keyword">LIKE</span> <span class="string">&#x27;%aa%&#x27;</span>;</span><br><span class="line"></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> id,NAME <span class="keyword">FROM</span> tbl_user <span class="keyword">WHERE</span> NAME <span class="keyword">LIKE</span> <span class="string">&#x27;%aa%&#x27;</span>;</span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> id,NAME,age <span class="keyword">FROM</span> tbl_user <span class="keyword">WHERE</span> NAME <span class="keyword">LIKE</span> <span class="string">&#x27;%aa%&#x27;</span>;</span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> NAME,age <span class="keyword">FROM</span> tbl_user <span class="keyword">WHERE</span> NAME <span class="keyword">LIKE</span> <span class="string">&#x27;%aa%&#x27;</span>;</span><br><span class="line"></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tbl_user <span class="keyword">WHERE</span> NAME <span class="keyword">LIKE</span> <span class="string">&#x27;%aa%&#x27;</span>;</span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> id,NAME,age,email <span class="keyword">FROM</span> tbl_user <span class="keyword">WHERE</span> NAME <span class="keyword">LIKE</span> <span class="string">&#x27;%aa%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654084573485.png"></p>
<p>在没建索引前结果都是采用全表扫描ALL</p>
<p> 现在创建索引 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> INDEX idx_user_nameAge <span class="keyword">ON</span> tbl_user(NAME,age);</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654084710100.png"></p>
<p> 再执行上述一系列explain </p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654084783340.png"></p>
<p> 看得出，用上索引（覆盖索引） </p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654084904406.png"></p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654084955805.png"></p>
<p>看得出，都没用上索引了，有email字段再，只能全表搜索。</p>
<p>覆盖索引（Covering Index）,一说为索引覆盖。</p>
<p>理解方式一：就是select的数据列只用从索引中就能够取得，不必读取数据行，MySQL可以利用索引返回select列表中的字段，而不必根据索引再次读取数据文件，换句话说查询列要被所建的索引覆盖。</p>
<p>理解方式二：索引是高效找到行的一个方法，但是一般数据库也能使用索引找到一个列的数据，因此它不必读取整个行。毕竟索引叶子节点存储了它们索引的数据；当能通过读取索引就可以得到想要的数据，那就不需要读取行了。一个索引包含了（或覆盖了）满足查询结果的数据就叫做覆盖索引。</p>
<p>覆盖索引建立的索引和我查的字段个数和顺序上最好完全一致</p>
<p>注意：</p>
<p>如果要使用覆盖索引，一定要注意select列表中只取出需要的列，不可select*，因为</p>
<p>如果将所有字段一起做索引会导致索引文件过大，查询性能下降。</p>
<p><strong>小结</strong></p>
<p>解决like ‘%字符串%’时索引不被使用的方法？复合索引，然后覆盖索引。</p>
<h6 id="索引失效8-数目字符串不加单引号"><a href="#索引失效8-数目字符串不加单引号" class="headerlink" title="索引失效8-数目字符串不加单引号"></a>索引失效8-数目字符串不加单引号</h6><p><strong>数目字符串不加单引号索引失效</strong>。</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654085206431.png"></p>
<p>name是varchar类型的，但写的语句给的是int类型的，Mysql会自己在底层将int的2000转为varchar的2000，这是mysql在索引列上进行了自动的类型转换，违背了第二条（不在索引列上做额外操作），所以索引失效</p>
<h6 id="索引失效9-用关键字OR"><a href="#索引失效9-用关键字OR" class="headerlink" title="索引失效9-用关键字OR"></a>索引失效9-用关键字OR</h6><p><strong>少用or，用它来连接时会索引失效</strong>。</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654085344611.png"></p>
<h5 id="索引失效10-小总结"><a href="#索引失效10-小总结" class="headerlink" title="索引失效10-小总结"></a>索引失效10-小总结</h5><p><strong>小总结</strong></p>
<p>假设index(a, b, c)</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654085404331.png"></p>
<h5 id="索引面试题分析"><a href="#索引面试题分析" class="headerlink" title="索引面试题分析"></a>索引面试题分析</h5><p>新建SQL</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test03(</span><br><span class="line">    id <span class="type">int</span> <span class="keyword">primary</span> key <span class="keyword">not</span> <span class="keyword">null</span> auto_increment,</span><br><span class="line">    c1 <span class="type">char</span>(<span class="number">10</span>),</span><br><span class="line">    c2 <span class="type">char</span>(<span class="number">10</span>),</span><br><span class="line">    c3 <span class="type">char</span>(<span class="number">10</span>),</span><br><span class="line">    c4 <span class="type">char</span>(<span class="number">10</span>),</span><br><span class="line">    c5 <span class="type">char</span>(<span class="number">10</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test03(c1,c2,c3,c4,c5) <span class="keyword">values</span> (<span class="string">&#x27;a1&#x27;</span>,<span class="string">&#x27;a2&#x27;</span>,<span class="string">&#x27;a3&#x27;</span>,<span class="string">&#x27;a4&#x27;</span>,<span class="string">&#x27;a5&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test03(c1,c2,c3,c4,c5) <span class="keyword">values</span> (<span class="string">&#x27;b1&#x27;</span>,<span class="string">&#x27;b2&#x27;</span>,<span class="string">&#x27;b3&#x27;</span>,<span class="string">&#x27;b4&#x27;</span>,<span class="string">&#x27;b5&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test03(c1,c2,c3,c4,c5) <span class="keyword">values</span> (<span class="string">&#x27;c1&#x27;</span>,<span class="string">&#x27;c2&#x27;</span>,<span class="string">&#x27;c3&#x27;</span>,<span class="string">&#x27;c4&#x27;</span>,<span class="string">&#x27;c5&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test03(c1,c2,c3,c4,c5) <span class="keyword">values</span> (<span class="string">&#x27;d1&#x27;</span>,<span class="string">&#x27;d2&#x27;</span>,<span class="string">&#x27;d3&#x27;</span>,<span class="string">&#x27;d4&#x27;</span>,<span class="string">&#x27;d5&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test03(c1,c2,c3,c4,c5) <span class="keyword">values</span> (<span class="string">&#x27;e1&#x27;</span>,<span class="string">&#x27;e2&#x27;</span>,<span class="string">&#x27;e3&#x27;</span>,<span class="string">&#x27;e4&#x27;</span>,<span class="string">&#x27;e5&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> index idx_test03_c1234 <span class="keyword">on</span> test03(c1,c2,c3,c4);</span><br></pre></td></tr></table></figure>

<p>表：  select * from test03; </p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654085486980.png"></p>
<p>看索引： show index from test03; </p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654085521779.png"></p>
<p> 问题：我们创建了复合索引idx_test03_c1234 ，根据以下SQL分析下索引使用情况？ </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test03 <span class="keyword">where</span> c1<span class="operator">=</span><span class="string">&#x27;a1&#x27;</span>;</span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test03 <span class="keyword">where</span> c1<span class="operator">=</span><span class="string">&#x27;a1&#x27;</span> <span class="keyword">and</span> c2<span class="operator">=</span><span class="string">&#x27;a2&#x27;</span>;</span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test03 <span class="keyword">where</span> c1<span class="operator">=</span><span class="string">&#x27;a1&#x27;</span> <span class="keyword">and</span> c2<span class="operator">=</span><span class="string">&#x27;a2&#x27;</span> <span class="keyword">and</span> c3<span class="operator">=</span><span class="string">&#x27;a3&#x27;</span>;</span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test03 <span class="keyword">where</span> c1<span class="operator">=</span><span class="string">&#x27;a1&#x27;</span> <span class="keyword">and</span> c2<span class="operator">=</span><span class="string">&#x27;a2&#x27;</span> <span class="keyword">and</span> c3<span class="operator">=</span><span class="string">&#x27;a3&#x27;</span> <span class="keyword">and</span> c4<span class="operator">=</span><span class="string">&#x27;a4&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654085800911.png"></p>
<p> 换一下条件顺序 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test03 <span class="keyword">where</span> c1<span class="operator">=</span><span class="string">&#x27;a1&#x27;</span> <span class="keyword">and</span> c2<span class="operator">=</span><span class="string">&#x27;a2&#x27;</span> <span class="keyword">and</span> c3<span class="operator">=</span><span class="string">&#x27;a3&#x27;</span> <span class="keyword">and</span> c4<span class="operator">=</span><span class="string">&#x27;a4&#x27;</span>;</span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test03 <span class="keyword">where</span> c1<span class="operator">=</span><span class="string">&#x27;a1&#x27;</span> <span class="keyword">and</span> c2<span class="operator">=</span><span class="string">&#x27;a2&#x27;</span> <span class="keyword">and</span> c4<span class="operator">=</span><span class="string">&#x27;a4&#x27;</span> <span class="keyword">and</span> c3<span class="operator">=</span><span class="string">&#x27;a3&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654085897956.png"></p>
<p>因为MySQL自己会排顺序</p>
<p>限定范围</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test03 <span class="keyword">where</span> c1<span class="operator">=</span><span class="string">&#x27;a1&#x27;</span> <span class="keyword">and</span> c2<span class="operator">=</span><span class="string">&#x27;a2&#x27;</span> <span class="keyword">and</span> c3<span class="operator">&gt;</span><span class="string">&#x27;a3&#x27;</span> <span class="keyword">and</span> c4<span class="operator">=</span><span class="string">&#x27;a4&#x27;</span>;</span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test03 <span class="keyword">where</span> c1<span class="operator">=</span><span class="string">&#x27;a1&#x27;</span> <span class="keyword">and</span> c2<span class="operator">=</span><span class="string">&#x27;a2&#x27;</span> <span class="keyword">and</span> c4<span class="operator">&gt;</span><span class="string">&#x27;a4&#x27;</span> <span class="keyword">and</span> c3<span class="operator">=</span><span class="string">&#x27;a3&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654086185772.png"></p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654086307594.png"></p>
<p>order by</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test03 <span class="keyword">where</span> c1<span class="operator">=</span><span class="string">&#x27;a1&#x27;</span> <span class="keyword">and</span> c2<span class="operator">=</span><span class="string">&#x27;a2&#x27;</span> <span class="keyword">and</span> c4<span class="operator">=</span><span class="string">&#x27;a4&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> c3;</span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test03 <span class="keyword">where</span> c1<span class="operator">=</span><span class="string">&#x27;a1&#x27;</span> <span class="keyword">and</span> c2<span class="operator">=</span><span class="string">&#x27;a2&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> c3;</span><br></pre></td></tr></table></figure>

<p> <img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654086870556.png"></p>
<p><strong>c3其实也用到了没有显示因为c3在这里的作用在排序而不是查找</strong> </p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654086951084.png"></p>
<p>和上面一样和c4无关</p>
<p>上面两个explain的相同。</p>
<p>order by c3换成order by c4</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test03 <span class="keyword">where</span> c1<span class="operator">=</span><span class="string">&#x27;a1&#x27;</span> <span class="keyword">and</span> c2<span class="operator">=</span><span class="string">&#x27;a2&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> c4;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654087063155.png"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test03 <span class="keyword">where</span> c1<span class="operator">=</span><span class="string">&#x27;a1&#x27;</span> <span class="keyword">and</span> c5<span class="operator">=</span><span class="string">&#x27;a5&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> c2,c3;</span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test03 <span class="keyword">where</span> c1<span class="operator">=</span><span class="string">&#x27;a1&#x27;</span> <span class="keyword">and</span> c5<span class="operator">=</span><span class="string">&#x27;a5&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> c3,c2;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654087191685.png"></p>
<p> 只用c1一个字段索引，但是c2、c3用于排序，无filesort。 </p>
<p> 出现了filesort，我们建的索引是1234，它没有按照顺序来，3，2颠倒了。 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test03 <span class="keyword">where</span> c1<span class="operator">=</span><span class="string">&#x27;a1&#x27;</span> <span class="keyword">and</span> c2<span class="operator">=</span><span class="string">&#x27;a2&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> c2,c3;</span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test03 <span class="keyword">where</span> c1<span class="operator">=</span><span class="string">&#x27;a1&#x27;</span> <span class="keyword">and</span> c2<span class="operator">=</span><span class="string">&#x27;a2&#x27;</span> <span class="keyword">and</span> c5<span class="operator">=</span><span class="string">&#x27;a5&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> c2,c3;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654087363533.png"></p>
<p> 用c1、c2两个字段索引，但是c2、c3用于排序，无filesort </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test03 <span class="keyword">where</span> c1<span class="operator">=</span><span class="string">&#x27;a1&#x27;</span> <span class="keyword">and</span> c2<span class="operator">=</span><span class="string">&#x27;a2&#x27;</span> <span class="keyword">and</span> c5<span class="operator">=</span><span class="string">&#x27;a5&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> c3,c2;</span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test03 <span class="keyword">where</span> c1<span class="operator">=</span><span class="string">&#x27;a1&#x27;</span> <span class="keyword">and</span> c5<span class="operator">=</span><span class="string">&#x27;a5&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> c3,c2;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654087600995.png"></p>
<p> 跳过c2，就用c3，就出现Using filesort。 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test03 <span class="keyword">where</span> c1<span class="operator">=</span><span class="string">&#x27;a1&#x27;</span> <span class="keyword">and</span> c4<span class="operator">=</span><span class="string">&#x27;a4&#x27;</span> <span class="keyword">group</span> <span class="keyword">by</span> c2,c3;</span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test03 <span class="keyword">where</span> c1<span class="operator">=</span><span class="string">&#x27;a1&#x27;</span> <span class="keyword">and</span> c4<span class="operator">=</span><span class="string">&#x27;a4&#x27;</span> <span class="keyword">group</span> <span class="keyword">by</span> c3,c2;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654087713901.png"></p>
<p>定值、范围还是排序，一般order by是给个范围</p>
<p>group by基本上都需要进行排序，会有临时表产生</p>
<p>一般性建议</p>
<ul>
<li>对于单键索引，尽量选择针对当前query过滤性更好的索引。</li>
<li>在选择组合索引的时候，当前Query中过滤性最好的字段在索引字段顺序中，位置越靠前越好。</li>
<li>在选择组合索引的时候，尽量选择可以能够包含当前query中的where字句中更多字段的索引。</li>
<li>尽可能通过分析统计信息和调整query的写法来达到选择合适索引的目的。</li>
</ul>
<h5 id="索引优化答疑补充和总结口诀"><a href="#索引优化答疑补充和总结口诀" class="headerlink" title="索引优化答疑补充和总结口诀"></a>索引优化答疑补充和总结口诀</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test03 <span class="keyword">where</span> c1<span class="operator">=</span><span class="string">&#x27;a1&#x27;</span> <span class="keyword">and</span> c2 <span class="keyword">like</span> <span class="string">&#x27;kk%&#x27;</span> <span class="keyword">and</span> c3<span class="operator">=</span><span class="string">&#x27;a3&#x27;</span>;</span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test03 <span class="keyword">where</span> c1<span class="operator">=</span><span class="string">&#x27;a1&#x27;</span> <span class="keyword">and</span> c2 <span class="keyword">like</span> <span class="string">&#x27;%kk&#x27;</span> <span class="keyword">and</span> c3<span class="operator">=</span><span class="string">&#x27;a3&#x27;</span>;</span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test03 <span class="keyword">where</span> c1<span class="operator">=</span><span class="string">&#x27;a1&#x27;</span> <span class="keyword">and</span> c2 <span class="keyword">like</span> <span class="string">&#x27;%kk%&#x27;</span> <span class="keyword">and</span> c3<span class="operator">=</span><span class="string">&#x27;a3&#x27;</span>;</span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test03 <span class="keyword">where</span> c1<span class="operator">=</span><span class="string">&#x27;a1&#x27;</span> <span class="keyword">and</span> c2 <span class="keyword">like</span> <span class="string">&#x27;k%kk%&#x27;</span> <span class="keyword">and</span> c3<span class="operator">=</span><span class="string">&#x27;a3&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654088701433.png"></p>
<p>like是一种范围</p>
<p>%在右边相等于%前面有常量了，范围range,c2是以kk开头的，c3也能使用了。</p>
<p>%在开头，是1个kk还是2个kk还是10个kk,不知道，只有c1用上了索引</p>
<p>%kk%,只有c1用上了索引</p>
<p>k%kk%,三个索引，like后面是常量开头</p>
<p>小总结**</p>
<p>假设index(a, b, c)</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654088600342.png"></p>
<p><strong>优化总结口诀</strong></p>
<p>全值匹配我最爱， 最左前缀要遵守；</p>
<p>带头大哥不能死， 中间兄弟不能断；</p>
<p>索引列上少计算， 范围之后全失效；</p>
<p>LIKE 百分写最右， 覆盖索引不写 *；</p>
<p>不等空值还有 OR， 索引影响要注意；</p>
<p>VAR 引号不可丢， SQL 优化有诀窍</p>
<h2 id="3-查询截取分析"><a href="#3-查询截取分析" class="headerlink" title="3.查询截取分析"></a>3.查询截取分析</h2><p>通常SQL调优过程：</p>
<ul>
<li>观察，至少跑1天，看看生产的慢SQL情况。</li>
<li>开启慢查询日志，设置阙值，比如超过5秒钟的就是慢SQL，并将它抓取出来。</li>
<li>explain + 慢SQL分析。</li>
<li>show profile。</li>
<li>运维经理 or DBA，进行SQL数据库服务器的参数调优。</li>
</ul>
<p>总结：</p>
<ul>
<li>慢查询的开启并捕获</li>
<li>explain + 慢SQL分析</li>
<li>show profile查询SQL在Mysql服务器里面的执行细节和生命周期情况</li>
<li>SQL数据库服务器的参数调优。</li>
</ul>
<h3 id="3-1-查询优化"><a href="#3-1-查询优化" class="headerlink" title="3.1 查询优化"></a>3.1 查询优化</h3><h4 id="3-1-1-小表驱动大表"><a href="#3-1-1-小表驱动大表" class="headerlink" title="3.1.1 小表驱动大表"></a>3.1.1 小表驱动大表</h4><p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654090481717.png"></p>
<p>优化原则：小表驱动大表，即小的数据集驱动大的数据集。</p>
<p>RBO原理</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> A <span class="keyword">where</span> id <span class="keyword">in</span> (<span class="keyword">select</span> id <span class="keyword">from</span> B)</span><br><span class="line">等价于:</span><br><span class="line"><span class="keyword">for</span> <span class="keyword">select</span> id <span class="keyword">from</span> B</span><br><span class="line"><span class="keyword">for</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> A <span class="keyword">where</span> A.id <span class="operator">=</span> B.id</span><br></pre></td></tr></table></figure>

<p> 当B表的数据集必须小于A表的数据集时，用in优于exists。 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> A <span class="keyword">where</span> <span class="keyword">exists</span> (<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> B <span class="keyword">where</span> B.id <span class="operator">=</span> A.id)</span><br><span class="line">等价于：</span><br><span class="line"><span class="keyword">for</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> A</span><br><span class="line"><span class="keyword">for</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> B <span class="keyword">where</span> B.id <span class="operator">=</span> A.id</span><br></pre></td></tr></table></figure>

<p>当A表的数据集系小于B表的数据集时，用exists优于in。</p>
<p>注意：A表与B表的ID字段应建立索引。</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654517085625.png"></p>
<p><strong>EXISTS关键字</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ...<span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> <span class="keyword">EXISTS</span> (subquery)</span><br></pre></td></tr></table></figure>

<p>该语法可以理解为：将主查询的数据，放到子查询中做条件验证，根据验证结果（TRUE或FALSE）来决定主查询的数据结果是否得以保留。</p>
<p>提示</p>
<ul>
<li>EXSTS(subquey)只返回TRUE或FALSE，因此子查询中的SELECT * 也可以是 SELECT 1 或select ‘X’，官方说法是实际执行时会忽略SELECT清单，因此没有区别。</li>
<li>EXISTS子查询的实际执行过程可能经过了优化而不是我们理解上的逐条对比，如果担忧效率问题，可进行实际检验以确定是否有效率问题。</li>
<li>EXISTS子查询往往也可以用条件表达式，其他子查询或者JOIN来替代，何种最优需要具体问题具体分析</li>
</ul>
<h4 id="3-1-2-order-by关键字优化"><a href="#3-1-2-order-by关键字优化" class="headerlink" title="3.1.2 order by关键字优化"></a>3.1.2 order by关键字优化</h4><p>ORDER BY子句，尽量使用Index方式排序，避免使用FileSort方式排序。</p>
<p>新建SQL</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tblA(</span><br><span class="line">    #id <span class="type">int</span> <span class="keyword">primary</span> key <span class="keyword">not</span> <span class="keyword">null</span> auto_increment,</span><br><span class="line">    age <span class="type">int</span>,</span><br><span class="line">    birth <span class="type">timestamp</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tblA(age, birth) <span class="keyword">values</span>(<span class="number">22</span>, now());</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tblA(age, birth) <span class="keyword">values</span>(<span class="number">23</span>, now());</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tblA(age, birth) <span class="keyword">values</span>(<span class="number">24</span>, now());</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> index idx_A_ageBirth <span class="keyword">on</span> tblA(age, birth);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tblA;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654518676627.png"></p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654518711265.png"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tblA <span class="keyword">where</span> age <span class="operator">&gt;</span> <span class="number">20</span> <span class="keyword">order</span> <span class="keyword">by</span> age;</span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tblA <span class="keyword">where</span> age <span class="operator">&gt;</span> <span class="number">20</span> <span class="keyword">order</span> <span class="keyword">by</span> age,birth;</span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tblA <span class="keyword">where</span> age <span class="operator">&gt;</span> <span class="number">20</span> <span class="keyword">order</span> <span class="keyword">by</span> birth;</span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tblA <span class="keyword">where</span> age <span class="operator">&gt;</span> <span class="number">20</span> <span class="keyword">order</span> <span class="keyword">by</span> birth,age;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654518989572.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM tblA order by birth;</span><br><span class="line">EXPLAIN SELECT * FROM tblA WHERE birth &gt; &#x27;2016-01-28 00:00:00&#x27; order by birth;</span><br><span class="line">EXPLAIN SELECT * FROM tblA WHERE birth &gt; &#x27;2016-01-28 00:00:00&#x27; order by age;</span><br><span class="line"> EXPLAIN SELECT * FROM tblA order by age, birth desc;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654519835468.png"></p>
<p>MySQL支持二种方式的排序，FileSort和lIndex，Index效率高，它指MySQL扫描索引本身完成排序。FileSort方式效率较低。</p>
<p>ORDER BY满足两情况，会使用Index方式排序：</p>
<ul>
<li><p>ORDER BY语句使用索引最左前列。</p>
</li>
<li><p>使用where子句与Order BY子句条件列组合满足索引最左前列。</p>
</li>
</ul>
<p>如果不在索引列上，mysql的filesort有两种算法：</p>
<ul>
<li>双路排序</li>
<li>单路排序</li>
</ul>
<p>双路排序</p>
<ul>
<li><p>MySQL4.1之前是使用双路排序，字面意思就是两次扫描磁盘，最终得到数据，读取行指针和OrderBy列，对他们进行排序，然后扫描已经排序好的列表，按照列表中的值重新从列表中读对应的数据输出。</p>
</li>
<li><p>从磁盘取排序字段，在buffer进行排序，再从磁盘取其他字段。</p>
</li>
<li><p>取一批数据，要对磁盘进行了两次扫描，众所周知，I\O是很耗时的，所以在mysql4.1之后，出现了第二种改进的算法，就是单路排序。</p>
</li>
</ul>
<p>单路排序</p>
<ul>
<li>从磁盘读取查询需要的所有列，按照order by列在buffer对它们进行排序，然后扫描排序压的列表进行输出，它的效率更快一些，避免了第二次读取数据。并且把随机IO变成了顺序IO,但是它会使用更多的空间，因为它把每一行都保存在内存中了。</li>
</ul>
<p>结论及引申出的问题</p>
<ul>
<li><p>由于单路是后出的，总体而言好过双路</p>
</li>
<li><p>但是用单路有问题</p>
</li>
</ul>
<p>在sort_buffer中，方法B比方法A要多占用很多空间，因为方法B是把所有字段都取出,所以有可能取出的数据的总大小超出了sort_buffer的容量，导致每次只能取sort_buffer容量大小的数据，进行排序（创建tmp文件，多路合并)，排完再取取<br>sort_buffer容量大小，再排……从而多次I&#x2F;O。</p>
<p>本来想省一次I&#x2F;O操作，反而导致了大量的I&#x2F;O操作，反而得不偿失。</p>
<p>优化策略</p>
<ul>
<li>增大sort_buffer_size参数的设置</li>
<li>增大max_length_for_sort_data参数的设置</li>
</ul>
<p>为什么设置sort_buffer_size、max_length_for_sort_data参数能优化排序？</p>
<p>提高Order By的速度</p>
<ul>
<li><p>Order by时select * 是一个大忌只Query需要的字段，这点非常重要。在这里的影响是:</p>
<ul>
<li><p>当Query的字段大小总和小于max_length_for_sort_data而且排序字段不是TEXT|BLOB类型时，会用改进后的算法——单路排序，否则用老算法——多路排序。</p>
</li>
<li><p>两种算法的数据都有可能超出sort_buffer的容量，超出之后，会创建tmp文件进行合并排序，导致多次IO，但是用单路排序算法的风险会更大一些，所以要提高sort_buffer__size。</p>
</li>
</ul>
</li>
<li><p>尝试提高sort_buffer_size，不管用哪种算法，提高这个参数都会提高效率，当然，要根据系统的能力去提高，因为这个参数是针对每个进程的。</p>
</li>
<li><p>尝试提高max_length_for_sort_data，提高这个参数，会增加用改进算法的概率。但是如果设的太高，数据总容量超出sort_buffer_size的概率就增大，明显症状是高的磁盘I&#x2F;O活动和低的处理器使用率。</p>
</li>
</ul>
<p>小结</p>
<p>为排序使用索引</p>
<ul>
<li>MySql两种排序方式∶文件排序 或 扫描有序索引排序</li>
<li>MySql能为 排序 与 查询 使用相同的索引</li>
</ul>
<p>创建复合索引 a_b_c (a, b, c)</p>
<p>order by能使用索引最左前缀</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> a</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> a, b</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> a, b, c</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> a <span class="keyword">DESC</span>, b <span class="keyword">DESC</span>, c <span class="keyword">DESC</span></span><br></pre></td></tr></table></figure>


<p>如果WHERE使用素引的最左前缀定义为常量，则order by能使用索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WHERE</span> a <span class="operator">=</span> const <span class="keyword">ORDER</span> <span class="keyword">BY</span> b,c</span><br><span class="line"><span class="keyword">WHERE</span> a <span class="operator">=</span> const <span class="keyword">AND</span> b <span class="operator">=</span> const <span class="keyword">ORDER</span> <span class="keyword">BY</span> c</span><br><span class="line"><span class="keyword">WHERE</span> a <span class="operator">=</span> const <span class="keyword">ORDER</span> <span class="keyword">BY</span> b, c</span><br><span class="line"><span class="keyword">WHERE</span> a <span class="operator">=</span> const <span class="keyword">AND</span> b <span class="operator">&gt;</span> const <span class="keyword">ORDER</span> <span class="keyword">BY</span> b, c</span><br></pre></td></tr></table></figure>


<p>不能使用索引进行排序</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> a <span class="keyword">ASC</span>, b <span class="keyword">DESC</span>, c <span class="keyword">DESC</span> <span class="operator">/</span><span class="operator">/</span>排序不—致</span><br><span class="line"><span class="keyword">WHERE</span> g <span class="operator">=</span> const <span class="keyword">ORDER</span> <span class="keyword">BY</span> b, c <span class="operator">/</span><span class="operator">/</span>产丢失a索引</span><br><span class="line"><span class="keyword">WHERE</span> a <span class="operator">=</span> const <span class="keyword">ORDER</span> <span class="keyword">BY</span> c <span class="operator">/</span><span class="operator">/</span>产丢失b索引</span><br><span class="line"><span class="keyword">WHERE</span> a <span class="operator">=</span> const <span class="keyword">ORDER</span> <span class="keyword">BY</span> a, d <span class="operator">/</span><span class="operator">/</span>d不是素引的一部分</span><br><span class="line"><span class="keyword">WHERE</span> a <span class="keyword">in</span> (…) <span class="keyword">ORDER</span> <span class="keyword">BY</span> b, c <span class="operator">/</span><span class="operator">/</span>对于排序来说,多个相等条件也是范围查询 a是范围</span><br></pre></td></tr></table></figure>

<h4 id="3-1-3-group-by关键字优化"><a href="#3-1-3-group-by关键字优化" class="headerlink" title="3.1.3 group by关键字优化"></a>3.1.3 group by关键字优化</h4><p>GroupBy优化</p>
<ul>
<li>group by实质是先排序后进行分组，遵照索引建的最佳左前缀。</li>
<li>当无法使用索引列，增大max_length_for_sort_data参数的设置 + 增大sort_buffer_size参数的设置。</li>
<li>where高于having，能写在where限定的条件就不要去having限定了。</li>
</ul>
<h3 id="3-2-慢查询日志"><a href="#3-2-慢查询日志" class="headerlink" title="3.2 慢查询日志"></a>3.2 慢查询日志</h3><p>MySQL的慢查询日志是MySQL提供的一种日志记录，它用来记录在MySQL中响应时间超过阀值的语句，具体指运行时间超过long_query_time值的SQL，则会被记录到慢查询日志中。<br>具体指运行时间超过long_query_time值的SQL，则会被记录到慢查询日志中。</p>
<p>long_query_time的默认值为10，意思是运行10秒以上的语句。</p>
<p>由他来查看哪些SQL超出了我们的最大忍耐时间值，比如一条sql执行超过5秒钟，我们就算慢SQL，希望能收集超过5秒的sql，结合之前explain进行全面分析。</p>
<p>如何操作</p>
<ul>
<li><strong>默认情况下，MySQL数据库没有开启慢查询日速</strong>，需要我们手动来设置这个参数。</li>
<li><strong>当然，如果不是调优需要的话，一般不建议启动该参数</strong>，因为开启慢查询日志会或多或少带来一定的性能影响。慢查询日志支持将日志记录写入文件。</li>
</ul>
<p>查看是否开启及如何开启</p>
<ul>
<li>默认 - SHOW VARIABLES LIKE ‘%slow_query_log%’;</li>
<li>开启 - set global slow_query_log&#x3D;1;，只对当前数据库生效，如果MySQL重启后则会失效。<br><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654521686860.png"></li>
</ul>
<p>如果要永久生效，就必须修改配置文件my.cnf(其它系统变量也是如此)</p>
<p>修改my.cnf文件，[mysqld]下增加或修改参数slow_query_log和slow_query_log_file后，然后重启MySQL服务器。也即将如下两行配置进my.cnf文件</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">slow_query_log <span class="operator">=</span><span class="number">1</span></span><br><span class="line">slow_query_log_file<span class="operator">=</span><span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>localhost(主机名)<span class="operator">-</span>slow.log</span><br></pre></td></tr></table></figure>

<p>关于慢查询的参数slow_query_log_file，它指定慢查询日志文件的存放路径，系统默认会给一个缺省的文件host_name-slow.log（如果没有指定参数slow_query_log_file的话）</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654521794229.png"></p>
<p>开启了慢查询日志后，什么样的SQL才会记录到慢查询日志里面呢？</p>
<p>这个是由参数long_query_time控制，默认情况下long_query_time的值为10秒，命令：SHOW VARIABLES LIKE ‘long_query_time%’;</p>
<p>可以使用命令修改，也可以在my.cnf参数里面修改。</p>
<p>假如运行时间正好等于long_query_time的情况，并不会被记录下来。也就是说，在mysql源码里是判断大于long_query_time，而非大于等于。</p>
<p>设置慢SQL阈值时间：set global long_query_time&#x3D;3;</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654521837504.png"></p>
<p><strong>为什么设置后看不出变化？</strong></p>
<p>需要重新连接或新开一个会话才能看到修改值。</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654521901709.png"></p>
<p><strong>记录慢SQL并后续分析</strong></p>
<p>假设我们成功设置慢SQL阈值时间为3秒（<code>set global long_query_time=3;</code>）。</p>
<p>模拟超时SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> sleep(<span class="number">4</span>);</span><br></pre></td></tr></table></figure>

<p> 日志记录： </p>
<p>到这个文件中去找</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654521794229-1688999366994.png"></p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654522015698.png"></p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654522114151.png"></p>
<p> <strong>查询当前系统中有多少条慢查询记录</strong> </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;%slow_queries&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p> <img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654522175071.png"></p>
<p><strong>在配置文件中设置慢SQL阈值时间</strong> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#[mysqld]下配置:</span><br><span class="line">slow_query_log=1;</span><br><span class="line">slow_query_log_file=/var/lib/mysql/localhost-slow.log</span><br><span class="line">long_query_time=3;</span><br><span class="line">log_output=FILE;</span><br></pre></td></tr></table></figure>

<h4 id="日志分析工具mysqldumpslow"><a href="#日志分析工具mysqldumpslow" class="headerlink" title="日志分析工具mysqldumpslow"></a>日志分析工具mysqldumpslow</h4><p>在生产环境中，如果要手工分析日志，查找、分析SQL，显然是个体力活，MySQL提供了日志分析工具mysqldumpslow。</p>
<p>查看mysqldumpslow的帮助信息，<code>mysqldumpslow --help</code>。</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654523780000.png"></p>
<ul>
<li>s：是表示按照何种方式排序</li>
<li>c：访问次数</li>
<li>l：锁定时间</li>
<li>r：返回记录</li>
<li>t：查询时间</li>
<li>al：平均锁定时间</li>
<li>ar：平均返回记录数</li>
<li>at：平均查询时间</li>
<li>t：即为返回前面多少条的数据</li>
<li>g：后边搭配一个正则匹配模式，大小写不敏感的</li>
</ul>
<p>工作常用参考</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">得到返回记录集最多的<span class="number">10</span>个<span class="keyword">SQL</span></span><br><span class="line"></span><br><span class="line">mysqldumpslow <span class="operator">-</span>s r <span class="operator">-</span>t <span class="number">10</span> <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span>localhost<span class="operator">-</span>slow.log</span><br><span class="line"></span><br><span class="line">得到访问次数最多的<span class="number">10</span>个<span class="keyword">SQL</span></span><br><span class="line"></span><br><span class="line">mysqldumpslow <span class="operator">-</span>s c <span class="operator">-</span>t <span class="number">10</span> <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span>localhost<span class="operator">-</span>slow.log</span><br><span class="line"></span><br><span class="line">得到按照时间排序的前<span class="number">10</span>条里面含有左连接的查询语句</span><br><span class="line"></span><br><span class="line">mysqldumpslow <span class="operator">-</span>s t <span class="operator">-</span>t <span class="number">10</span> <span class="operator">-</span>g &quot;left join&quot; <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span>localhost<span class="operator">-</span>slow.log</span><br><span class="line"></span><br><span class="line">另外建议在使用这些命令时结合│和more 使用，否则有可能出现爆屏情况</span><br><span class="line"></span><br><span class="line">mysqldumpslow <span class="operator">-</span>s r<span class="operator">-</span>t <span class="number">10</span> <span class="operator">/</span>ar<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span>localhost<span class="operator">-</span>slow.log <span class="operator">|</span> more</span><br></pre></td></tr></table></figure>

<h3 id="3-3-批量数据脚本"><a href="#3-3-批量数据脚本" class="headerlink" title="3.3 批量数据脚本"></a>3.3 批量数据脚本</h3><p>往表里插入1000W数据</p>
<ol>
<li><strong>创建SQL</strong></li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> database bigData;</span><br><span class="line">use bigData;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> dept(</span><br><span class="line">	id <span class="type">INT</span> UNSIGNED <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT,</span><br><span class="line">	deptno MEDIUMINT UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">	dname <span class="type">VARCHAR</span>(<span class="number">20</span>)<span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> &quot;&quot;,</span><br><span class="line">	loc <span class="type">VARCHAR</span>(<span class="number">13</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> &quot;&quot;</span><br><span class="line">)ENGINE<span class="operator">=</span>INNODB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> emp(</span><br><span class="line">    id <span class="type">int</span> unsigned <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">    empno mediumint unsigned <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> <span class="number">0</span>,</span><br><span class="line">    ename <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> &quot;&quot;,</span><br><span class="line">    job <span class="type">varchar</span>(<span class="number">9</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> &quot;&quot;,</span><br><span class="line">    mgr mediumint unsigned <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> <span class="number">0</span>,</span><br><span class="line">    hiredate <span class="type">date</span> <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    sal <span class="type">decimal</span>(<span class="number">7</span>,<span class="number">2</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    comm <span class="type">decimal</span>(<span class="number">7</span>,<span class="number">2</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    deptno mediumint unsigned <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> <span class="number">0</span></span><br><span class="line">)ENGINE<span class="operator">=</span>INNODB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>

<p>2.<strong>设置参数log_bin_trust_function_creators</strong></p>
<p>创建函数，假如报错：This function has none of DETERMINISTIC…</p>
<p>由于开启过慢查询日志，因为我们开启了bin-log，我们就必须为我们的function指定一个参数。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;log_bin_trust_function_creators&#x27;</span>;</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> log_bin_trust_function_creators<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654590988327.png"></p>
<p>这样添加了参数以后，如果mysqld重启，上述参数又会消失，永久方法：</p>
<ul>
<li><p>windows下my.ini[mysqld]加上log_bin_trust_function_creators&#x3D;1</p>
</li>
<li><p>linux下&#x2F;etc&#x2F;my.cnf 下my.cnf[mysqld]加上log_bin_trust_function_creators&#x3D;1</p>
</li>
</ul>
<p>3.<strong>创建函数，保证每条数据都不同</strong></p>
<p>随机产生字符串</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">delimiter $$ # 两个 $$ 表示结束</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> rand_string(n <span class="type">int</span>) <span class="keyword">returns</span> <span class="type">varchar</span>(<span class="number">255</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">declare</span> chars_str <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">default</span> <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz&#x27;</span>;</span><br><span class="line">    <span class="keyword">declare</span> return_str <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">declare</span> i <span class="type">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">    while i <span class="operator">&lt;</span> n do</span><br><span class="line">        <span class="keyword">set</span> return_str <span class="operator">=</span> concat(return_str,<span class="built_in">substring</span>(chars_str,<span class="built_in">floor</span>(<span class="number">1</span><span class="operator">+</span>rand()<span class="operator">*</span><span class="number">52</span>),<span class="number">1</span>));</span><br><span class="line">        <span class="keyword">set</span> i<span class="operator">=</span>i<span class="operator">+</span><span class="number">1</span>;</span><br><span class="line">    <span class="keyword">end</span> while;</span><br><span class="line">    <span class="keyword">return</span> return_str;</span><br><span class="line"><span class="keyword">end</span> $$</span><br></pre></td></tr></table></figure>

<p> 随机产生部门编号 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> rand_num() <span class="keyword">returns</span> <span class="type">int</span>(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">declare</span> i <span class="type">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">set</span> i<span class="operator">=</span><span class="built_in">floor</span>(<span class="number">100</span><span class="operator">+</span>rand()<span class="operator">*</span><span class="number">10</span>);</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line"><span class="keyword">end</span> $$</span><br></pre></td></tr></table></figure>

<p> 运行结果 </p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654591509042.png"></p>
<p><strong>4.创建存储过程</strong></p>
<p>创建往emp表中插入数据的存储过程</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> insert_emp(<span class="keyword">in</span> <span class="keyword">start</span> <span class="type">int</span>(<span class="number">10</span>),<span class="keyword">in</span> max_num <span class="type">int</span>(<span class="number">10</span>))</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">declare</span> i <span class="type">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">set</span> autocommit <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    repeat</span><br><span class="line">        <span class="keyword">set</span> i <span class="operator">=</span> i<span class="operator">+</span><span class="number">1</span>;</span><br><span class="line">        <span class="keyword">insert</span> <span class="keyword">into</span> emp(empno,ename,job,mgr,hiredate,sal,comm,deptno) <span class="keyword">values</span>((<span class="keyword">start</span><span class="operator">+</span>i),rand_string(<span class="number">6</span>),<span class="string">&#x27;salesman&#x27;</span>,<span class="number">0001</span>,curdate(),<span class="number">2000</span>,<span class="number">400</span>,rand_num());</span><br><span class="line">        until i<span class="operator">=</span>max_num</span><br><span class="line">        <span class="keyword">end</span> repeat;</span><br><span class="line">    <span class="keyword">commit</span>;</span><br><span class="line"><span class="keyword">end</span> $$</span><br></pre></td></tr></table></figure>

<p> 创建往dept表中插入数据的存储过程 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> insert_dept(<span class="keyword">in</span> <span class="keyword">start</span> <span class="type">int</span>(<span class="number">10</span>),<span class="keyword">in</span> max_num <span class="type">int</span>(<span class="number">10</span>))</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">declare</span> i <span class="type">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">set</span> autocommit <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    repeat</span><br><span class="line">        <span class="keyword">set</span> i <span class="operator">=</span> i<span class="operator">+</span><span class="number">1</span>;</span><br><span class="line">        <span class="keyword">insert</span> <span class="keyword">into</span> dept(deptno,dname,loc) <span class="keyword">values</span>((<span class="keyword">start</span><span class="operator">+</span>i),rand_string(<span class="number">10</span>),rand_string(<span class="number">8</span>));</span><br><span class="line">        until i<span class="operator">=</span>max_num</span><br><span class="line">        <span class="keyword">end</span> repeat;</span><br><span class="line">    <span class="keyword">commit</span>;</span><br><span class="line"><span class="keyword">end</span> $$</span><br></pre></td></tr></table></figure>

<p><strong>5.调用存储过程</strong></p>
<p>往dept表中插入数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER ;</span><br><span class="line"><span class="keyword">CALL</span> insert_dept(<span class="number">100</span>, <span class="number">10</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654592166810.png"></p>
<p>往emp表中插入50万数据 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER ;</span><br><span class="line"><span class="keyword">CALL</span> insert_emp(<span class="number">100001</span>, <span class="number">500000</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp;<span class="operator">/</span><span class="operator">/</span>查看数据</span><br></pre></td></tr></table></figure>

<h3 id="3-4-Show-Profile"><a href="#3-4-Show-Profile" class="headerlink" title="3.4 Show Profile"></a>3.4 Show Profile</h3><p>用Show Profile进行sql分析</p>
<p>Show Profile是mysql提供可以用来分析当前会话中语句执行的资源消耗情况。可以用于SQL的调优的测量。</p>
<p>默认情况下，参数处于关闭状态，并保存最近15次的运行结果。</p>
<p><strong>分析步骤</strong></p>
<p>1.是否支持，看看当前的mysql版本是否支持。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;profiling&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>默认是关闭，使用前需要开启。</p>
<p>2.开启功能，默认是关闭，使用前需要开启。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> profiling<span class="operator">=</span><span class="keyword">on</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654593895466.png"></p>
<p> 3.运行SQL </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">select * from tbl_emp;</span><br><span class="line">select * from tbl_emp e inner join tbl_dept d on e.deptId=d.id;</span><br><span class="line">select * from tbl_emp e left join tbl_dept d on e.deptId=d.id;</span><br><span class="line">select * from emp group by id%10 limit 150000;</span><br><span class="line">select * from emp group by id%20 order by 5;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> 4.查看结果，<code>show profiles;</code> </p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654594511574.png"></p>
<p> 5.诊断SQL，<code>show profile cpu,block io for query 上一步前面的问题SQL数字号码;</code> </p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654594590020.png"></p>
<p>参数备注:show profile   …..</p>
<ul>
<li>ALL：显示所有的开销信息。</li>
<li>BLOCK IO：显示块lO相关开销。</li>
<li>CONTEXT SWITCHES ：上下文切换相关开销。</li>
<li>CPU：显示CPU相关开销信息。</li>
<li>IPC：显示发送和接收相关开销信息。</li>
<li>MEMORY：显示内存相关开销信息。</li>
<li>PAGE FAULTS：显示页面错误相关开销信息。</li>
<li>SOURCE：显示和Source_function，Source_file，Source_line相关的开销信息。</li>
<li>SWAPS：显示交换次数相关开销的信息。</li>
</ul>
<p>6.日常开发需要注意的结论</p>
<ul>
<li>converting HEAP to MyISAM 查询结果太大，内存都不够用了往磁盘上搬了。</li>
<li>Creating tmp table 创建临时表，拷贝数据到临时表，用完再删除</li>
<li>Copying to tmp table on disk 把内存中临时表复制到磁盘，危险!</li>
<li>locked<br><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654594744380.png"></li>
</ul>
<h3 id="3-5-全局查询日志"><a href="#3-5-全局查询日志" class="headerlink" title="3.5 全局查询日志"></a>3.5 全局查询日志</h3><p>永远不要在生产环境开启这个功能。一般是在测试环境下开启。</p>
<p>配置文件启用。在mysql的my.cnf中，设置如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#开启</span><br><span class="line">general_log<span class="operator">=</span><span class="number">1</span></span><br><span class="line">#记录日志文件的路径</span><br><span class="line">general_log_file<span class="operator">=</span><span class="operator">/</span>path<span class="operator">/</span>logfile</span><br><span class="line">#输出格式</span><br><span class="line">log_output<span class="operator">=</span>FILE</span><br></pre></td></tr></table></figure>

<p>编码启用。命令如下：</p>
<ul>
<li><code>set global general_log=1;</code></li>
<li><code>set global log_output=&#39;TABLE&#39;;</code></li>
</ul>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654601567862.png"></p>
<p> 此后，你所编写的sql语句，将会记录到mysql库里的geneial_log表，可以用下面的命令查看： select * from mysql.general_log;</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654601659085.png"></p>
<h2 id="4-mysql锁的机制"><a href="#4-mysql锁的机制" class="headerlink" title="4.mysql锁的机制"></a>4.mysql锁的机制</h2><h3 id="4-1数据库锁理论概述"><a href="#4-1数据库锁理论概述" class="headerlink" title="4.1数据库锁理论概述"></a>4.1数据库锁理论概述</h3><p><strong>定义：</strong></p>
<p>锁是计算机协调多个进程或线程并发访问某一资源的机制。</p>
<p>在数据库中，除传统的计算资源（如CPU、RAM、I&#x2F;O等）的争用以外，数据也是一种供许多用户共享的资源。如何保证数据并发访问的一致性、有效性是所有数据库必须解决的一个问题，锁冲突也是影响数据库并发访问性能的一个重要因素。从这个角度来说，锁对数据库而言显得尤其重要，也更加复杂。</p>
<p><strong>类比：网上购物</strong></p>
<p>打个比方，我们到淘宝上买一件商品，商品只有一件库存，这个时候如果还有另一个人买，那么如何解决是你买到还是另一个人买到的问题？</p>
<p>这里肯定要用到事务，我们先从库存表中取出物品数量，然后插入订单，付款后插入付款表信息，然后更新商品数量。在这个过程中，使用锁可以对有限的资源进行保护，解决隔离和并发的矛盾。</p>
<p><strong>锁的分类</strong></p>
<ul>
<li><p>从对数据操作的类型（读\写）分</p>
<ul>
<li><p>读锁（共享锁）：针对同一份数据，多个读操作可以同时进行而不会互相影响。</p>
</li>
<li><p>写锁（排它锁）：当前写操作没有完成前，它会阻断其他写锁和读锁。</p>
</li>
</ul>
</li>
<li><p>从对数据操作的粒度分</p>
<ul>
<li><p>表锁</p>
</li>
<li><p>行锁</p>
</li>
</ul>
</li>
</ul>
<h3 id="4-2-读锁案例讲解"><a href="#4-2-读锁案例讲解" class="headerlink" title="4.2 读锁案例讲解"></a>4.2 读锁案例讲解</h3><h4 id="4-2-1-读锁"><a href="#4-2-1-读锁" class="headerlink" title="4.2.1 读锁"></a>4.2.1 读锁</h4><p>表锁（偏读）</p>
<p>特点：偏向MyISAM存储引擎，开销小，加锁快；无死锁；锁定粒度大，发生锁冲突的概率最高，并发度最低。</p>
<p>案例分析</p>
<p>建表SQL</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> mylock (</span><br><span class="line">    id <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">) engine myisam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> mylock(name) <span class="keyword">values</span>(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> mylock(name) <span class="keyword">values</span>(<span class="string">&#x27;b&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> mylock(name) <span class="keyword">values</span>(<span class="string">&#x27;c&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> mylock(name) <span class="keyword">values</span>(<span class="string">&#x27;d&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> mylock(name) <span class="keyword">values</span>(<span class="string">&#x27;e&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mylock;</span><br></pre></td></tr></table></figure>

<p> 运行结果 </p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654604273643.png"></p>
<p>手动增加表锁</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lock <span class="keyword">table</span> 表名字 read(write), 表名字<span class="number">2</span> read(write), 其他;</span><br></pre></td></tr></table></figure>

<p> <img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654604571358.png"></p>
<p>查看表上加过的锁 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">open</span> tables;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654604413514.png"></p>
<p> 释放锁 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unlock tables;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654604599100.png"></p>
<p> <strong>加读锁——为mylock表加read锁（读阻塞写例子）</strong> </p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654604862268-1688999179924.png"></p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654605043025-1688999234651.png"></p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/-1688998443126.png"></p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654605170571.png"></p>
<h4 id="4-2-2-写锁"><a href="#4-2-2-写锁" class="headerlink" title="4.2.2 写锁"></a>4.2.2 写锁</h4><p>为mylock表加write锁（MylSAM存储引擎的写阻塞读例子）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lock <span class="keyword">table</span> mylock write;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654606718501.png"></p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654606837985.png"></p>
<p>在session2中也查询了，但被阻塞了</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654606892204.png"></p>
<p>session1中锁被释放了unlock table;，session2就查询到了</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654606947998.png"></p>
<h4 id="4-2-3-总结"><a href="#4-2-3-总结" class="headerlink" title="4.2.3 总结"></a>4.2.3 总结</h4><p>MyISAM在执行查询语句（SELECT）前，会自动给涉及的所有表加读锁，在执行增删改操作前，会自动给涉及的表加写锁。</p>
<p>MySQL的表级锁有两种模式：</p>
<ol>
<li>表共享读锁(Table Read Lock)</li>
<li>表独占写锁(Table Write Lock)</li>
</ol>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654607504829.png"></p>
<p>结合上表，所以对MyISAM表进行操作，会有以下情况：</p>
<p>对MyISAM表的读操作（加读锁），不会阻塞其他进程对同一表的读请求，但会阻塞对同一表的写请求。只有当读锁释放后，才会执行其它进程的写操作。</p>
<p>对MyISAM表的写操作〈加写锁），会阻塞其他进程对同一表的读和写操作，只有当写锁释放后，才会执行其它进程的读写操作。</p>
<p>简而言之，就是<strong>读锁会阻塞写，但是不会堵塞读。而写锁则会把读和写都堵塞</strong>。</p>
<h3 id="4-3-表锁分析"><a href="#4-3-表锁分析" class="headerlink" title="4.3 表锁分析"></a>4.3 表锁分析</h3><p>看看哪些表被加锁了,有1的就代表被锁了</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">open</span> tables;</span><br></pre></td></tr></table></figure>

<p><em>如何分析表锁定</em></p>
<p>可以通过检查table_locks_waited和table_locks_immediate状态变量来分析系统上的表锁定。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> status <span class="keyword">like</span> <span class="string">&#x27;table_locks%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654607851044.png"></p>
<p>这里有两个状态变量记录MySQL内部表级锁定的情况，两个变量说明如下：</p>
<ul>
<li>Table_locks_immediate：产生表级锁定的次数，表示可以立即获取锁的查询次数，每立即获取锁值加1 ;</li>
<li>Table_locks_waited：出现表级锁定争用而发生等待的次数(不能立即获取锁的次数，每等待一次锁值加1)，此值高则说明存在着较严重的表级锁争用情况；</li>
</ul>
<p>此外，MyISAM的读写锁调度是写优先，这也是MyISAM不适合做写为主表的引擎。因为写锁后，其他线程不能做任何操作，大量的更新会使查询很难得到锁，从而造成永远阻塞。</p>
<p>Table_locks_waited数值越高越不好。</p>
<h3 id="4-4-行锁理论"><a href="#4-4-行锁理论" class="headerlink" title="4.4 行锁理论"></a>4.4 行锁理论</h3><p>偏向InnoDB存储引擎，开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低，并发度也最高。</p>
<p>InnoDB与MyISAM的最大不同有两点：一是支持事务(TRANSACTION)；二是采用了行级锁。</p>
<h4 id="4-4-1-由于行锁支持事务，复习老知识"><a href="#4-4-1-由于行锁支持事务，复习老知识" class="headerlink" title="4.4.1 由于行锁支持事务，复习老知识"></a>4.4.1 由于行锁支持事务，复习老知识</h4><p>事务(Transaction）及其ACID属性</p>
<p><strong>并发事务处理带来的问题</strong></p>
<p>事务隔离级别</p>
<p>事务是由一组SQL语句组成的逻辑处理单元，事务具有以下4个属性，通常简称为事务的ACID属性：</p>
<ul>
<li>原子性(Atomicity）：事务是一个原子操作单元，其对数据的修改，要么全都执行，要么全都不执行。</li>
<li>一致性（Consistent）：在事务开始和完成时，数据都必须保持一致状态。这意味着所有相关的数据规则都必须应用于事务的修改，以保持数据的完整性;事务结束时，所有的内部数据结构〈如B树索引或双向链表）也都必须是正确的。</li>
<li>隔离性（lsolation）：数据库系统提供一定的隔离机制，保证事务在不受外部并发操作影响的“独立”环境执行。这意味着事务处理过程中的中间状态对外部是不可见的，反之亦然。</li>
<li>持久性（Durable）：事务完成之后，它对于数据的修改是永久性的，即使出现系统故障也能够保持。</li>
</ul>
<p><strong>并发事务处理带来的问题</strong></p>
<ul>
<li>更新丢失(Lost Update)</li>
<li>脏读(Dirty Reads)</li>
<li>不可重复读(Non-Repeatable Reads)</li>
<li>幻读(Phantom Reads)</li>
</ul>
<p>更新丢失(Lost Update)</p>
<ul>
<li><p>当两个或多个事务选择同一行，然后基于最初选定的值更新该行时，由于每个事务都不知道其他事务的存在，就会发生丢失更新问题――最后的更新覆盖了由其他事务所做的更新。</p>
</li>
<li><p>例如，两个程序员修改同一java文件。每程序员独立地更改其副本，然后保存更改后的副本，这样就覆盖了原始文档。最后保存其更改副本的编辑人员覆盖前一个程序员所做的更改。</p>
</li>
<li><p>如果在一个程序员完成并提交事务之前，另一个程序员不能访问同一文件，则可避免此问题。</p>
</li>
</ul>
<p>脏读(Dirty Reads)</p>
<ul>
<li><p>一个事务正在对一条记录做修改，在这个事务完成并提交前，这条记录的数据就处于不一致状态；这时，另一个事务也来读取同一条记录，如果不加控制，第二个事务读取了这些“脏”数据，并据此做进一步的处理，就会产生未提交的数据依赖关系。这种现象被形象地叫做”脏读”。</p>
</li>
<li><p>一句话：事务A读取到了事务B<strong>已修改但尚未提交</strong>的的数据，还在这个数据基础上做了操作。此时，如果B事务回滚，A读取的数据无效，不符合一致性要求。</p>
</li>
</ul>
<p>不可重复读(Non-Repeatable Reads)</p>
<ul>
<li><p>一个事务在读取某些数据后的某个时间，再次读取以前读过的数据，却发现其读出的数据已经发生了改变、或某些记录已经被删除了!这种现象就叫做“不可重复读”。</p>
</li>
<li><p>一句话：事务A读取到了事务B已经提交的修改数据，不符合隔离性。</p>
</li>
</ul>
<p>幻读(Phantom Reads)</p>
<ul>
<li><p>一个事务接相同的查询条件重新读取以前检索过的数据，却发现其他事务插入了满足其查询条件的新数据，这种现象就称为“幻读“。</p>
</li>
<li><p>一句话:事务A读取到了事务B体提交的新增数据，不符合隔离性。</p>
</li>
</ul>
<p>多说一句：幻读和脏读有点类似，</p>
<p>脏读是事务B里面修改了数据，</p>
<p>幻读是事务B里面新增了数据。</p>
<p><strong>事务隔离级别</strong></p>
<p>”脏读”、“不可重复读”和“幻读”，其实都是数据库读一致性问题，必须由数据库提供一定的事务隔离机制来解决。</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654609114890.png"></p>
<p>数据库的事务隔离越严格，并发副作用越小，但付出的代价也就越大，因为事务隔离实质上就是使事务在一定程度上“串行化”进行，这显然与“并发”是矛盾的。同时，不同的应用对读一致性和事务隔离程度的要求也是不同的，比如许多应用对“不可重复读”和“幻读”并不敏感，可能更关心数据并发访问的能力。</p>
<p>常看当前数据库的事务隔离级别：show variables like ‘tx_isolation’;<br><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654609401859.png"></p>
<p>可重复读</p>
<h4 id="4-4-2-行锁案例讲解"><a href="#4-4-2-行锁案例讲解" class="headerlink" title="4.4.2 行锁案例讲解"></a>4.4.2 行锁案例讲解</h4><p>新建SQL</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_innodb_lock (a <span class="type">INT</span>(<span class="number">11</span>),b <span class="type">VARCHAR</span>(<span class="number">16</span>))ENGINE<span class="operator">=</span>INNODB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_innodb_lock <span class="keyword">VALUES</span>(<span class="number">1</span>,<span class="string">&#x27;b2&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_innodb_lock <span class="keyword">VALUES</span>(<span class="number">3</span>,<span class="string">&#x27;3&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_innodb_lock <span class="keyword">VALUES</span>(<span class="number">4</span>, <span class="string">&#x27;4000&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_innodb_lock <span class="keyword">VALUES</span>(<span class="number">5</span>,<span class="string">&#x27;5000&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_innodb_lock <span class="keyword">VALUES</span>(<span class="number">6</span>, <span class="string">&#x27;6000&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_innodb_lock <span class="keyword">VALUES</span>(<span class="number">7</span>,<span class="string">&#x27;7000&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_innodb_lock <span class="keyword">VALUES</span>(<span class="number">8</span>, <span class="string">&#x27;8000&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_innodb_lock <span class="keyword">VALUES</span>(<span class="number">9</span>,<span class="string">&#x27;9000&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_innodb_lock <span class="keyword">VALUES</span>(<span class="number">1</span>,<span class="string">&#x27;b1&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> INDEX test_innodb_a_ind <span class="keyword">ON</span> test_innodb_lock(a);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX test_innodb_lock_b_ind <span class="keyword">ON</span> test_innodb_lock(b);</span><br></pre></td></tr></table></figure>

<p> 运行结果 </p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654610570175.png"></p>
<p><strong>行锁定基本演示</strong>（两个客户端更新同一行记录）</p>
<p>关闭自动提交set autocommit&#x3D;0;</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654682542082.png"></p>
<p>两个客户端更新不同的记录</p>
<p>session1</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654682840399.png"></p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654682840399.png"></p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654682911231-1688999100693.png"></p>
<p>session2</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654682890146.png"></p>
<p>两个客户端对不同的记录进行更改，互不影响，都commit提交后数据都改完了</p>
<h4 id="4-4-3-行锁演示答疑补充"><a href="#4-4-3-行锁演示答疑补充" class="headerlink" title="4.4.3 行锁演示答疑补充"></a>4.4.3 行锁演示答疑补充</h4><p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654683401053.png"></p>
<p>session1已经commit了，为啥session2还是查不了呢，因为session1和session2都设置了set autocommit&#x3D;0;取消了自动提交。必须得自动提交后才能看到新的更修改。</p>
<p>如果session2是自动提交，那么它一查询就会看到更改。</p>
<h4 id="4-4-4索引失效行锁变表锁"><a href="#4-4-4索引失效行锁变表锁" class="headerlink" title="4.4.4索引失效行锁变表锁"></a>4.4.4索引失效行锁变表锁</h4><p>无索引行锁升级为表锁</p>
<p> 数目字符串不加单引号索引失效，a是int类型，b是varchar类型的，ab都是索引</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/8465bd3028f93033eeb3b3015ae99f48.png"></p>
<h4 id="4-4-5-间隙锁危害"><a href="#4-4-5-间隙锁危害" class="headerlink" title="4.4.5 间隙锁危害"></a>4.4.5 间隙锁危害</h4><p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654688604820.png"></p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654688580899.png"></p>
<p>什么是间隙锁</p>
<ul>
<li><p>当我们用范围条件而不是相等条件检索数据，并请求共享或排他锁时，InnoDB会给符合条件的已有数据记录的索引项加锁，对于键值在条件范围内但并不存在的记录，叫做“间隙（GAP）”。</p>
</li>
<li><p>InnoDB也会对这个“间隙”加锁，这种锁机制就是所谓的间隙锁（Next-Key锁）。</p>
</li>
</ul>
<p>危害</p>
<ul>
<li>因为Query执行过程中通过过范围查找的话，他会锁定整个范围内所有的索引键值，即使这个键值并不存在。</li>
</ul>
<p>间隙锁有一个比较致命的弱点，就是当锁定一个范围键值之后，即使某些不存在的键值也会被无辜的锁定，而造成在锁定的时候无法插入锁定键值范围内的任何数据。在某些场景下这可能会对性能造成很大的危害。</p>
<h4 id="4-4-6-如何锁定一行"><a href="#4-4-6-如何锁定一行" class="headerlink" title="4.4.6 如何锁定一行"></a>4.4.6 如何锁定一行</h4><p>面试：如何锁定一行？begin…commit</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654689327614.png"></p>
<h4 id="4-4-7-行锁总结与页锁"><a href="#4-4-7-行锁总结与页锁" class="headerlink" title="4.4.7 行锁总结与页锁"></a>4.4.7 行锁总结与页锁</h4><p>Innodb存储引擎由于实现了行级锁定，虽然在锁定机制的实现方面所带来的性能损耗可能比表级锁定会要更高一些，但是在整体并发处理能力方面要远远优于MyISAM的表级锁定的。当系统并发量较高的时候，Innodb的整体性能和MylISAM相比就会有比较明显的优势了。</p>
<p>但是，Innodb的行级锁定同样也有其脆弱的一面，当我们使用不当的时候，可能会让Innodb的整体性能表现不仅不能比MyISAM高，甚至可能会更差。</p>
<p><strong>行锁分析</strong></p>
<p>如何分析行锁定<br>通过检查lnnoDB_row_lock状态变量来分析系统上的行锁的争夺情况</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show status like &#x27;innodb_row_lock%&#x27;;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654689824984.png"></p>
<p>对各个状态量的说明如下:</p>
<ul>
<li>Innodb_row_lock_current_waits：当前正在等待锁定的数量；</li>
<li>Innodb_row_lock_time：从系统启动到现在锁定总时间长度；</li>
<li>Innodb_row_lock_time_avg：每次等待所花平均时间；</li>
<li>Innodb_row_lock_time_max：从系统启动到现在等待最常的一次所花的时间；</li>
<li>Innodb_row_lock_waits：系统启动后到现在总共等待的次数；</li>
</ul>
<p>对于这5个状态变量，比较重要的主要是</p>
<ul>
<li>Innodb_row_lock_time_avg（等待平均时长）</li>
<li>lnnodb_row_lock_waits（等待总次数）</li>
<li>lnnodb_row_lock_time（等待总时长）这三项。</li>
</ul>
<p>尤其是当等待次数很高，而且每次等待时长也不小的时候，我们就需要分析系统中为什么会有如此多的等待，然后根据分析结果着手指定优化计划。采用show profile</p>
<p><strong>优化建议</strong></p>
<ul>
<li>尽可能让所有数据检索都通过索引来完成，避免无索引行锁升级为表锁(varchar一定要加’’)。</li>
<li>合理设计索引，尽量缩小锁的范围</li>
<li>尽可能较少检索条件，避免间隙锁</li>
<li>尽量控制事务大小，减少锁定资源量和时间长度</li>
<li>尽可能低级别事务隔离</li>
</ul>
<p>页锁</p>
<p>开销和加锁时间界于表锁和行锁之间;会出现死锁;锁定粒度界于表锁和行锁之间，并发度一般。（了解一下即可）</p>
<h2 id="5-主从复制"><a href="#5-主从复制" class="headerlink" title="5.主从复制"></a>5.主从复制</h2><p><strong>复制的基本原理</strong></p>
<p>slave会从master读取binlog来进行数据同步</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654692759090.png"></p>
<p>三步骤+原理图</p>
<p><strong>MySQL</strong>复制过程分成三步****</p>
<ul>
<li>master将改变记录到二进制日志(binary log)。这些记录过程叫做二进制日志事件，binary log events;</li>
<li>slave将master的binary log events拷贝到它的中继日志(relay log) ;</li>
<li>slave重做中继日志中的事件，将改变应用到自己的数据库中。MySQL复制是异步的且串行化的</li>
</ul>
<p>复制的基本原则</p>
<ul>
<li>每个slave只有一个master</li>
<li>每个slave只能有一个唯一的服务器ID</li>
<li>每个master可以有多个salve</li>
</ul>
<p>复制的最大问题是延迟。</p>
<p><strong>一主一从常见配置</strong></p>
<ul>
<li><p>mysql版本一致且后台以服务运行</p>
</li>
<li><p>主从都配置在[mysqld]结点下，都是小写</p>
</li>
<li><p>主机修改my.ini配置文件</p>
<p><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654693051600.png"></p>
</li>
</ul>
<p><strong>从机修改my.cnf配置文件</strong></p>
<p>[必须]从服务器唯一ID</p>
<p>[可选]启用二进制日志</p>
<p><strong>配置文件，请主机+从机都重启后台mysql服务</strong></p>
<ul>
<li>service mysql stop</li>
<li>service mysql start</li>
</ul>
<p><strong>主机从机都关闭防火墙</strong></p>
<ul>
<li><p>windows手动关闭</p>
</li>
<li><p>关闭虚拟机linux防火墙 service iptables stop</p>
</li>
</ul>
<p><strong>在Windows主机上建立帐户并授权slave</strong></p>
<p>GRANT REPLICATION SLAVE ON <em>.</em> TO ‘zhangsan’@‘从机器数据库IP’ IDENTIFIED BY ‘123456’;</p>
<p>flush privileges;&#x2F;&#x2F;刷新</p>
<p>查询master的状态</p>
<ul>
<li>show master status;</li>
<li>记录下File和Position的值<br><img src="/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/1654694352268.png"></li>
</ul>
<p>执行完此步骤后不要再操作主服务器MYSQL，防止主服务器状态值变化<br><strong>在Linux从机上配置需要复制的主机</strong></p>
<ul>
<li><p>CHANGE MASTER TO MASTER_HOST&#x3D;’主机<br>IP’, MASTER_USER&#x3D;‘zhangsan’, MASTER_PASSWORD&#x3D;’123456’, MASTER_LOG_FILE&#x3D;’File名字’, MASTER_LOG_POS&#x3D;Position数字;</p>
</li>
<li><p>启动从服务器复制功能</p>
<ul>
<li>start slave;</li>
</ul>
</li>
<li><p>show slave status\G</p>
<ul>
<li><p>下面两个参数都是Yes，则说明主从配置成功!</p>
</li>
<li><p>Slave_IO_Running：Yes</p>
</li>
<li><p>Slave_SQL_Running：Yes</p>
</li>
</ul>
</li>
</ul>
<p><strong>主机新建库、新建表、insert记录，从机复制</strong></p>
<p><strong>如何停止从服务复制功能</strong></p>
<p>stop slave;</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">HX</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://279692294.github.io/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/">http://279692294.github.io/2023/07/10/MySQL%E9%AB%98%E7%BA%A7/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">HX</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">
                                    <span class="chip bg-color">数据库</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2023/07/11/Tomcat%E9%83%A8%E7%BD%B2JavaWeb%E5%BA%94%E7%94%A8/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/8.jpg" class="responsive-img" alt="Tomcat部署JavaWeb应用">
                        
                        <span class="card-title">Tomcat部署JavaWeb应用</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2023-07-11
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            HX
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Tomcat/">
                        <span class="chip bg-color">Tomcat</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/07/10/Mybatis/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/5.jpg" class="responsive-img" alt="Mybatis">
                        
                        <span class="card-title">Mybatis</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-07-10
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            HX
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/dataBase/">
                        <span class="chip bg-color">dataBase</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2023</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">HX</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/blinkfox" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1181062873@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1181062873" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
